Quixe=function(){function quixe_prepare(e,t){game_image=e;var n=game_image.slice(0,64),r,i;for(r=0;r<n.length;r++)i=n[r].toString(16),i.length<2&&(i="0"+i),n[r]=i;game_signature=n.join(""),t&&(opt_rethrow_exceptions=t.rethrow_exceptions),t&&t.debug_info_data_chunk&&parse_inform_debug_data(t.debug_info_data_chunk)}function quixe_init(){if(vm_started){Glk.fatal_error("Quixe was inited twice!");return}try{setup_bytestring_table(),setup_operandlist_table(),setup_vm(),execute_loop()}catch(e){qstackdump(),Glk.fatal_error("Quixe init: "+show_exception(e));if(opt_rethrow_exceptions)throw e}}function quixe_resume(){try{done_executing=vm_stopped,execute_loop()}catch(e){qstackdump(),Glk.fatal_error("Quixe run: "+show_exception(e));if(opt_rethrow_exceptions)throw e}}function show_exception(e){if(typeof e=="string")return e;var t=e.toString();return e.message&&(t=t+" "+e.message),e.fileName&&(t=t+" "+e.fileName),e.lineNumber&&(t=t+" line:"+e.lineNumber),e.name&&(t=t+" "+e.name),e.number&&(t=t+" "+e.number),t}function qlog(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function qobjdump(e,t){var n,r;if(e instanceof Array){t&&t--;var i=e.map(function(e){return qobjdump(e,t)});return"["+i.join(",")+"]"}if(e instanceof Object){r=[];for(n in e){var s=e[n];t&&s instanceof Object&&(s=qobjdump(s,t-1)),r.push(n+":"+s)}return"{ "+r.join(", ")+" }"}return""+e}function qstackdump(){if(!stack||!stack.length)return;var e,t,n,r,i=[];for(e=0;e<stack.length;e++){r=stack[e];if(!r.vmfunc.funcaddr){i.push("(anonymous)");continue}t="0x"+r.vmfunc.funcaddr.toString(16),n=debuginfo.functionmap[r.vmfunc.funcaddr],n&&(t+=' "'+n.name+'"'),i.push(t)}qlog("VM stack dump: "+i.join(", "))}function setup_bytestring_table(){var e,t;for(e=0;e<256;e++)t=e.toString(16),e<16&&(t="0"+t),bytestring_table[e]=t;for(e=0;e<256;e++)e>=32&&e<127?e==34||e==39||e==92?t="\\"+String.fromCharCode(e):t=String.fromCharCode(e):e==10?t="\\n":t="\\x"+bytestring_table[e],quotechar_table[e]=t}function ByteRead4(e,t){return e[t]*16777216+e[t+1]*65536+e[t+2]*256+e[t+3]}function ByteRead2(e,t){return e[t]*256+e[t+1]}function ByteRead1(e,t){return e[t]}function Mem1(e){return memmap[e]}function Mem2(e){return memmap[e]*256+memmap[e+1]}function Mem4(e){return memmap[e]*16777216+memmap[e+1]*65536+memmap[e+2]*256+memmap[e+3]}function MemW1(e,t){memmap[e]=t&255}function MemW2(e,t){memmap[e]=t>>8&255,memmap[e+1]=t&255}function MemW4(e,t){memmap[e]=t>>24&255,memmap[e+1]=t>>16&255,memmap[e+2]=t>>8&255,memmap[e+3]=t&255}function BytePushString(e,t){for(var n=0;n<t.length;n++)e.push(t.charCodeAt(n))}function BytePush4(e,t){e.push(t>>24&255),e.push(t>>16&255),e.push(t>>8&255),e.push(t&255)}function BytePush2(e,t){e.push(t>>8&255),e.push(t&255)}function BytePush1(e,t){e.push(t&255)}function ByteWrite4(e,t,n){e[t]=n>>24&255,e[t+1]=n>>16&255,e[t+2]=n>>8&255,e[t+3]=n&255}function ByteReadString(e,t,n){return String.fromCharCode.apply(this,e.slice(t,t+n))}function QuoteMem1(e){return memmap[e]>=128?"0xffffff"+bytestring_table[memmap[e]]:"0x"+bytestring_table[memmap[e]]}function QuoteMem2(e){return memmap[e]>=128?"0xffff"+bytestring_table[memmap[e]]+bytestring_table[memmap[e+1]]:memmap[e]?"0x"+bytestring_table[memmap[e]]+bytestring_table[memmap[e+1]]:"0x"+bytestring_table[memmap[e+1]]}function QuoteMem4(e){return memmap[e]?"0x"+bytestring_table[memmap[e]]+bytestring_table[memmap[e+1]]+bytestring_table[memmap[e+2]]+bytestring_table[memmap[e+3]]:memmap[e+1]?"0x"+bytestring_table[memmap[e+1]]+bytestring_table[memmap[e+2]]+bytestring_table[memmap[e+3]]:memmap[e+2]?"0x"+bytestring_table[memmap[e+2]]+bytestring_table[memmap[e+3]]:"0x"+bytestring_table[memmap[e+3]]}function ReadArgByte(e){return e==4294967295?frame.valstack.pop()&255:Mem1(e)}function WriteArgByte(e,t){e==4294967295?frame.valstack.push(t&255):MemW1(e,t)}function ReadArgWord(e){return e==4294967295?frame.valstack.pop():Mem4(e)}function WriteArgWord(e,t){e==4294967295?frame.valstack.push(t):MemW4(e,t)}function ReadStructField(e,t){return e==4294967295?frame.valstack.pop():Mem4(e+4*t)}function WriteStructField(e,t,n){e==4294967295?frame.valstack.push(n):MemW4(e+4*t,n)}function SetResumeStore(e){resumevalue=e}function CharToString(e){return e<65536?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(e&1023)))}function QuoteCharToString(e){if(e<256)return quotechar_table[e];if(e<65536){e=e.toString(16);while(e.length<4)e="0"+e;return"\\u"+e}var t;return e-=65536,t=55296+(e>>10),e=56320+(e&1023),"\\u"+t.toString(16)+"\\u"+e.toString(16)}function QuoteStr1ToString(e){return QuoteCharToString(e.charCodeAt(0))}function QuoteEscapeString(e){return e=e.replace(regexp_string_unsafe,QuoteStr1ToString),'"'+e+'"'}function fatal_error(e){var t,n;if(arguments.length>1){e+=" (";for(t=1;t<arguments.length;t++)n=arguments[t],typeof n=="number"?n=n.toString(16):n=""+n,t!=1&&(e+=" "),e+=n;e+=")"}throw qlog(e),e}function make_code(val,arg){return arg===undefined?eval("function _func() {\n"+val+"\n}"):eval("function _func("+arg+") {\n"+val+"\n}"),_func}function VMFunc(e,t,n,r){e?(this.funcaddr=e,this.startpc=t,this.functype=Mem1(e)):(this.funcaddr=null,this.startpc=null,this.functype=null),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=n,this.rawformat=r,this.localsindex=[];var i,s,o=0;for(i=0;i<this.localsformat.length;i++){var u=this.localsformat[i];if(u.size==4)while(o&3)o++;else if(u.size==2)while(o&1)o++;for(s=0;s<u.count;s++)this.localsindex.push({size:u.size,pos:o}),o+=u.size}while(o&3)o++;this.locallen=o}function StackFrame(e){var t;this.vmfunc=e,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=e.localsindex,this.locals=[];for(t=0;t<this.localsindex.length;t++){var n=this.localsindex[t];this.locals[n.pos]=0}this.framelen=8+e.rawformat.length+e.locallen}function clone_stackframe(e){var t=new StackFrame(e.vmfunc);return t.depth=e.depth,t.framestart=e.framestart,t.framelen=e.framelen,t.valstack=e.valstack.slice(0),t.localspos=e.localspos,t.locals=e.locals.slice(0),t.framelen=e.framelen,t}function push_serialized_stackframe(e,t){BytePush4(t,e.framelen);var n=e.vmfunc.rawformat;BytePush4(t,8+n.length);for(var r=0;r<n.length;r++)t.push(n[r]);for(var r=0;r<e.vmfunc.localsindex.length;r++){var i=e.vmfunc.localsindex[r];if(i.size==4){while(t.length&3)t.push(0);BytePush4(t,e.locals[i.pos])}else if(i.size==2){while(t.length&1)t.push(0);BytePush2(t,e.locals[i.pos])}else BytePush1(t,e.locals[i.pos])}while(t.length&3)t.push(0);for(var r=0;r<e.valstack.length;r++)BytePush4(t,e.valstack[r])}function pop_deserialized_stackframe(e){var t=ByteRead4(e,e.length-4);if(t<0||t>=e.length)return qlog("Bad frameptr in serialized stack frame"),undefined;e=e.splice(t,e.length);var n=ByteRead4(e,0),r=ByteRead4(e,4),i=e.slice(8,r),s=[],o=8;for(;;){var u=ByteRead1(e,o);o++;var a=ByteRead1(e,o);o++;if(u==0)break;u!=1&&u!=2&&u!=4&&fatal_error("Invalid local variable size in function header.",u),s.push({size:u,count:a})}var f=new VMFunc(null,null,s,i),l=new StackFrame(f);l.framestart=t;for(var c=0;c<l.vmfunc.localsindex.length;c++){var h=l.vmfunc.localsindex[c];h.size==4?l.locals[h.pos]=ByteRead4(e,4+r+h.pos):h.size==2?l.locals[h.pos]=ByteRead2(e,4+r+h.pos):l.locals[h.pos]=ByteRead1(e,4+r+h.pos)}for(var p=n;p<e.length;p+=4)l.valstack.push(ByteRead4(e,p));return l}function VMTextEnv(e,t){e==0&&fatal_error("Tried to create a VMTextEnv for address zero."),this.addr=e,this.cacheable=t!==undefined,this.decoding_tree=t,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}function setup_operandlist_table(){function e(e,t){this.argsize=t?t:4,this.numops=e.length;var n=[];for(var r=0;r<e.length;r++)n.push(e.charAt(r));this.formlist=n}var t=new e(""),n=new e("L"),r=new e("LL"),i=new e("LLL"),s=new e("LLLL"),o=new e("LS"),u=new e("LLS"),a=new e("LLLLLLS"),f=new e("LLLLLLLS"),l=new e("LLSS"),c=new e("LC"),h=new e("LLC"),p=new e("LLLC"),d=new e("LLLLC"),v=new e("ES"),m=new e("LES"),g=new e("EES"),y=new e("F"),b=new e("LF"),w=new e("LLF"),E=new e("EF"),S=new e("EF",1),x=new e("EF",2),T=new e("S"),N=new e("SS"),C=new e("CL"),k=new e("C");operandlist_table={0:t,16:g,17:m,18:u,19:u,20:u,21:v,24:g,25:g,26:g,27:v,28:u,29:u,30:u,32:n,34:r,35:r,36:i,37:i,38:i,39:i,40:i,41:i,42:i,43:i,44:i,45:i,48:h,49:n,50:C,51:r,52:r,64:E,65:x,66:S,68:o,69:o,72:u,73:u,74:u,75:u,76:i,77:i,78:i,79:i,80:y,81:b,82:t,83:r,84:n,112:n,113:n,114:n,115:n,256:u,257:n,258:T,259:o,260:n,272:o,273:n,288:t,289:T,290:t,291:c,292:b,293:k,294:y,295:r,304:w,320:T,321:n,328:N,329:r,336:f,337:f,338:a,352:c,353:h,354:p,355:d,368:r,369:i,376:o,377:n,384:r,385:r,400:o,401:o,402:o,408:o,409:o,416:u,417:u,418:u,419:u,420:l,424:o,425:o,426:o,427:u,432:o,433:o,434:o,435:o,436:o,437:o,438:u,448:s,449:s,450:i,451:i,452:i,453:i,456:r,457:r}}function oputil_record_funcop(e){if(e.mode==0)return"null";var t="m"+e.mode;e.argsize!=null&&(t=t+"s"+e.argsize),e.addr!=null&&(t=t+"a"+e.addr);if(funcop_cache.key)return"funcop_cache."+t;var n={key:t,mode:e.mode,argsize:e.argsize,addr:e.addr};return funcop_cache[t]=n,"funcop_cache."+t}function oputil_store(e,t,n){switch(t.mode){case 8:if(t.argsize==4){var r=n[0];if(r==="0"){e.offstack.push(n);return}if(r==="_"){push_offstack_holdvar(e,n);return}}holdvar=alloc_holdvar(e,!0),e.offstack.push(holdvar),t.argsize==4?e.code.push(holdvar+"=("+n+");"):t.argsize==2?e.code.push(holdvar+"=0xffff&("+n+");"):e.code.push(holdvar+"=0xff&("+n+");");return;case 0:e.code.push("("+n+");");return;case 11:if(t.argsize==4){var r=n[0];if(r==="0"){store_offloc_value(e,t.addr,n,!1);return}if(r==="_"){store_offloc_value(e,t.addr,n,!0);return}}store_offloc_value(e,t.addr,undefined),t.argsize==4?e.code.push("frame.locals["+t.addr+"]=("+n+");"):t.argsize==2?e.code.push("frame.locals["+t.addr+"]=(0xffff &"+n+");"):e.code.push("frame.locals["+t.addr+"]=(0xff &"+n+");");return;case 15:t.argsize==4?e.code.push("MemW4("+t.addr+","+n+");"):t.argsize==2?e.code.push("MemW2("+t.addr+","+n+");"):e.code.push("MemW1("+t.addr+","+n+");");return;default:fatal_error("Unknown addressing mode in store func operand.")}}function oputil_push_callstub(e,t,n){n===undefined&&(n=e.cp),e.code.push("frame.valstack.push("+t+","+n+",frame.framestart);")}function oputil_push_substring_callstub(e){e.code.push("if (!substring) { substring=true;"),e.code.push("frame.valstack.push(0x11,0,nextcp,frame.framestart);"),e.code.push("}")}function oputil_unload_offstate(e,t){var n;e.offstack.length&&e.code.push("frame.valstack.push("+e.offstack.join(",")+");");if(e.offloc.length)for(n=0;n<e.offloc.length;n++)e.offloc[n]!==undefined&&e.offlocdirty[n]&&e.code.push("frame.locals["+n+"]="+e.offloc[n]+";");if(!t){var r;for(n=0;n<e.offloc.length;n++)r=e.offloc[n],r!==undefined&&e.holduse[r]!==undefined&&(e.holduse[r]=!1);e.offloc.length=0,e.offlocdirty.length=0;while(e.offstack.length)r=e.offstack.pop(),e.holduse[r]!==undefined&&(e.holduse[r]=!1)}}function oputil_flush_string(e){if(e.buffer.length==0)return;var t=e.buffer.join("");e.buffer.length=0,e.code.push("Glk.glk_put_jstring("+QuoteEscapeString(t)+");")}function oputil_signify_operand(e,t,n){var r;if(quot_isconstant(t))return r=Number(t),r&2147483648?""+(r-4294967296):t;r="("+t+"&0xffffffff)";if(n){var i=alloc_holdvar(e);return e.code.push(i+"="+r+";"),i}return r}function oputil_decode_float(e,t,n){var r;if(quot_isconstant(t))return r=Number(t),r==2147483648?"-0":""+decode_float(r);r="decode_float("+t+")";if(n){var i=alloc_holdvar(e);return e.code.push(i+"="+r+";"),i}return r}function oputil_perform_jump(e,t,n){if(quot_isconstant(t)){var r=Number(t);if(r==0||r==1)n&&(e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0),e.code.push("leave_function();"),e.code.push("pop_callstub("+r+");");else{oputil_unload_offstate(e,!n);var i=e.cp+r-2>>>0;e.code.push("pc = "+i+";"),e.vmfunc.pathaddrs[i]=!0}}else oputil_unload_offstate(e,!n),e.code.push("if (("+t+")==0 || ("+t+")==1) {"),e.code.push("leave_function();"),e.code.push("pop_callstub("+t+");"),e.code.push("}"),e.code.push("else {"),e.code.push("pc = ("+e.cp+"+("+t+")-2) >>>0;"),e.code.push("}");e.code.push("return;")}function alloc_holdvar(e,t){var n=0,r;for(;;){r="_hold"+n;if(!e.holduse[r])return e.holduse[r]=t?1:!0,r;n++}}function pop_offstack_holdvar(e){var t=e.offstack.pop();if(quot_isconstant(t))return t;var n=e.holduse[t];return n--,n==0&&(n=!0),e.holduse[t]=n,t}function push_offstack_holdvar(e,t){e.offstack.push(t);var n=e.holduse[t];!n||n===!0?n=1:n++,e.holduse[t]=n}function store_offloc_value(e,t,n,r){var i=e.offloc[t];if(i&&quot_isholdvar(i)){var s=e.holduse[i];s--,s==0&&(s=!0),e.holduse[i]=s}if(n===undefined){e.offloc[t]=undefined,e.offlocdirty[t]=!1;return}e.offloc[t]=n,e.offlocdirty[t]=!0;if(r){var o=n,s=e.holduse[o];!s||s===!0?s=1:s++,e.holduse[o]=s}}function transfer_to_offstack(e,t){var n;while(e.offstack.length<t)n=alloc_holdvar(e,!0),e.offstack.unshift(n),e.code.push(n+"=frame.valstack.pop();")}function quot_isconstant(e){return e[0]==="0"}function quot_isholdvar(e){return e[0]==="_"}function parse_operands(e,t,n,r){var i,s,o,u,a,f,l;r.desttype=0,r.numops=n.numops,i=t,t+=n.numops+1>>1;for(s=0;s<n.numops;s++){(s&1)==0?(o=Mem1(i),u=o&15):(u=o>>4&15,i++);var c=n.formlist[s];if(c=="L"){switch(u){case 8:e.offstack.length?r[s]=pop_offstack_holdvar(e):(l=alloc_holdvar(e),e.code.push(l+"=frame.valstack.pop();"),r[s]=l);continue;case 0:r[s]="0";continue;case 1:a=QuoteMem1(t),t++,r[s]=a;continue;case 2:a=QuoteMem2(t),t+=2,r[s]=a;continue;case 3:a=QuoteMem4(t),t+=4,r[s]=a;continue}if(u>=9&&u<=11){u==9?(f=Mem1(t),t++):u==10?(f=Mem2(t),t+=2):u==11&&(f=Mem4(t),t+=4);if(e.offloc[f]!==undefined){r[s]=e.offloc[f];continue}n.argsize==4?a="frame.locals["+f+"]":n.argsize==2?a="frame.locals["+f+"] & 0xffff":a="frame.locals["+f+"] & 0xff",l=alloc_holdvar(e,!0),e.code.push(l+"=("+a+");"),e.offloc[f]=l,e.offlocdirty[f]=!1,r[s]=l;continue}switch(u){case 15:f=Mem4(t)+ramstart,t+=4;break;case 14:f=Mem2(t)+ramstart,t+=2;break;case 13:f=Mem1(t)+ramstart,t++;break;case 7:f=Mem4(t),t+=4;break;case 6:f=Mem2(t),t+=2;break;case 5:f=Mem1(t),t++;break;default:fatal_error("Unknown addressing mode in load operand.")}n.argsize==4?a="Mem4("+f+")":n.argsize==2?a="Mem2("+f+")":a="Mem1("+f+")",l=alloc_holdvar(e),e.code.push(l+"=("+a+");"),r[s]=l;continue}if(c=="E"){switch(u){case 8:e.offstack.length?r[s]=pop_offstack_holdvar(e):r[s]="frame.valstack.pop()";continue;case 0:r[s]="0";continue;case 1:a=QuoteMem1(t),t++,r[s]=a;continue;case 2:a=QuoteMem2(t),t+=2,r[s]=a;continue;case 3:a=QuoteMem4(t),t+=4,r[s]=a;continue}if(u>=9&&u<=11){u==9?(f=Mem1(t),t++):u==10?(f=Mem2(t),t+=2):u==11&&(f=Mem4(t),t+=4);if(e.offloc[f]!==undefined){r[s]=e.offloc[f];continue}n.argsize==4?a="frame.locals["+f+"]":n.argsize==2?a="frame.locals["+f+"] & 0xffff":a="frame.locals["+f+"] & 0xff",l=alloc_holdvar(e,!0),e.code.push(l+"=("+a+");"),e.offloc[f]=l,e.offlocdirty[f]=!1,r[s]=l;continue}switch(u){case 15:f=Mem4(t)+ramstart,t+=4;break;case 14:f=Mem2(t)+ramstart,t+=2;break;case 13:f=Mem1(t)+ramstart,t++;break;case 7:f=Mem4(t),t+=4;break;case 6:f=Mem2(t),t+=2;break;case 5:f=Mem1(t),t++;break;default:fatal_error("Unknown addressing mode in load operand.")}n.argsize==4?a="Mem4("+f+")":n.argsize==2?a="Mem2("+f+")":a="Mem1("+f+")",r[s]=a;continue}if(c=="S"){switch(u){case 8:l=alloc_holdvar(e,!0),e.offstack.push(l),r[s]=l+"=(";continue;case 0:r[s]="(";continue}if(u>=9&&u<=11){u==9?(f=Mem1(t),t++):u==10?(f=Mem2(t),t+=2):u==11&&(f=Mem4(t),t+=4),n.argsize==4?(l=alloc_holdvar(e,!0),store_offloc_value(e,f,l,!1),r[s]=l+"=("):n.argsize==2?(store_offloc_value(e,f,undefined),r[s]="frame.locals["+f+"]=(0xffff &"):(store_offloc_value(e,f,undefined),r[s]="frame.locals["+f+"]=(0xff &");continue}switch(u){case 15:f=Mem4(t)+ramstart,t+=4;break;case 14:f=Mem2(t)+ramstart,t+=2;break;case 13:f=Mem1(t)+ramstart,t++;break;case 7:f=Mem4(t),t+=4;break;case 6:f=Mem2(t),t+=2;break;case 5:f=Mem1(t),t++;break;default:fatal_error("Unknown addressing mode in store operand.")}n.argsize==4?a="MemW4("+f+",":n.argsize==2?a="MemW2("+f+",":a="MemW1("+f+",",r[s]=a;continue}if(c=="F"){var h=r.func_store;switch(u){case 8:h.mode=8,h.argsize=n.argsize,r[s]=h;continue;case 0:h.mode=0,h.argsize=n.argsize,r[s]=h;continue}if(u>=9&&u<=11){u==9?(f=Mem1(t),t++):u==10?(f=Mem2(t),t+=2):u==11&&(f=Mem4(t),t+=4),h.mode=11,h.addr=f,h.argsize=n.argsize,r[s]=h;continue}switch(u){case 15:f=Mem4(t)+ramstart,t+=4;break;case 14:f=Mem2(t)+ramstart,t+=2;break;case 13:f=Mem1(t)+ramstart,t++;break;case 7:f=Mem4(t),t+=4;break;case 6:f=Mem2(t),t+=2;break;case 5:f=Mem1(t),t++;break;default:fatal_error("Unknown addressing mode in store operand.")}h.mode=15,h.addr=f,h.argsize=n.argsize,r[s]=h;continue}if(c=="C"){switch(u){case 8:r[s]="3,0";continue;case 0:r[s]="0,0";continue}if(u>=9&&u<=11){u==9?(f=Mem1(t),t++):u==10?(f=Mem2(t),t+=2):u==11&&(f=Mem4(t),t+=4),r[s]="2,"+f;continue}switch(u){case 15:f=Mem4(t)+ramstart,t+=4;break;case 14:f=Mem2(t)+ramstart,t+=2;break;case 13:f=Mem1(t)+ramstart,t++;break;case 7:f=Mem4(t),t+=4;break;case 6:f=Mem2(t),t+=2;break;case 5:f=Mem1(t),t++;break;default:fatal_error("Unknown addressing mode in store operand.")}r[s]="1,"+f;continue}fatal_error("Unknown operand type.",c)}return t}function compile_func(e){var t=e,n=Mem1(t);n!=192&&n!=193&&(n>=192&&n<=223?fatal_error("Call to unknown type of function.",t):fatal_error("Call to non-function.",t)),t++;var r=[],i=t,s=0;for(;;){var o=Mem1(t);t++;var u=Mem1(t);t++;if(o==0)break;o!=1&&o!=2&&o!=4&&fatal_error("Invalid local variable size in function header.",o),r.push({size:o,count:u})}var a=memmap.slice(i,t);while(a.length%4)a.push(0);return new VMFunc(e,t,r,a)}function compile_path(e,t,n){var r=t,i,s,o,u={vmfunc:e,cp:null,curiosys:n,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},a={};a.func_store={},u.code.push("");while(!u.path_ends){s=r,i=Mem1(r),i===undefined&&fatal_error("Tried to compile nonexistent address",r),r++,i&128&&(i&64?(i&=63,i=i*256|Mem1(r),r++,i=i*256|Mem1(r),r++,i=i*256|Mem1(r),r++):(i&=127,i=i*256|Mem1(r),r++));var f=operandlist_table[i];f||fatal_error("Encountered unknown opcode.",i),r=parse_operands(u,r,f,a),u.cp=r;var l=opcode_table[i];l||fatal_error("Encountered unhandled opcode.",i),l(u,a);for(o in u.holduse)u.holduse[o]===!0&&(u.holduse[o]=!1);e.pathaddrs[r]&&!u.path_ends&&(u.code.push("pc="+r+";"),oputil_unload_offstate(u),u.code.push("return;"),u.path_ends=!0)}u.offstack.length&&fatal_error("Path compilation ended with nonempty offstack.",u.offstack.length),u.offloc.length&&fatal_error("Path compilation ended with nonempty offloc.",u.offloc.length);var c=[];for(o in u.holduse)c.push(o);for(o in u.varsused)c.push(o);return c.length&&(u.code[0]="var "+c.join(",")+";"),make_code(u.code.join("\n"))}function enter_function(e,t){var n;total_function_calls++;var r=accel_address_map[e];if(r!==undefined){accel_function_calls++;var i=r(t,tempcallargs);pop_callstub(i);return}var s=vmfunc_table[e];s===undefined&&(s=compile_func(e),e<ramstart&&(vmfunc_table[e]=s)),pc=s.startpc;var o=new StackFrame(s);o.depth=stack.length,stack.length==0?o.framestart=0:o.framestart=frame.framestart+frame.framelen+4*frame.valstack.length,stack.push(o),frame=o;if(s.functype==192){for(n=t-1;n>=0;n--)frame.valstack.push(tempcallargs[n]);frame.valstack.push(t)}else for(n=0;n<t;n++){var u=s.localsindex[n];if(u===undefined)break;u.size==4?frame.locals[u.pos]=tempcallargs[n]:u.size==2?frame.locals[u.pos]=tempcallargs[n]&65535:u.size==1&&(frame.locals[u.pos]=tempcallargs[n]&255)}}function leave_function(){var e=frame.depth;stack.pop();if(stack.length==0)throw frame=null,ReturnedFromMain;frame=stack[stack.length-1],frame.depth!=e-1&&fatal_error("Stack inconsistent after function exit.")}function pop_stack_to(e){while(stack.length&&stack[stack.length-1].framestart>e)stack.pop();stack.length==0&&fatal_error("Stack evaporated during throw."),frame=stack[stack.length-1],e-=frame.framestart+frame.framelen,e<0&&fatal_error("Attempted to throw below the frame value stack."),e&3&&fatal_error("Attempted to throw to an unaligned address."),e>>>=2,e>frame.valstack.length&&fatal_error("Attempted to throw beyond the frame value stack."),frame.valstack.length=e}function pop_callstub(e){var t,n;isNaN(e)&&fatal_error("Function returned undefined value.");var r=frame.valstack.pop();r!=frame.framestart&&fatal_error("Call stub frameptr ("+r+") does not match frame ("+frame.framestart+")"),pc=frame.valstack.pop(),t=frame.valstack.pop(),n=frame.valstack.pop();switch(n){case 0:return;case 1:MemW4(t,e);return;case 2:frame.locals[t]=e;return;case 3:frame.valstack.push(e);return;case 17:fatal_error("String-terminator call stub at end of function call.");return;case 16:stream_string(0,pc,225,t);return;case 18:stream_num(0,pc,!0,t);return;case 19:stream_string(0,pc,224,t);return;case 20:stream_string(0,pc,226,t);return;default:fatal_error("Unrecognized desttype in callstub.",n)}}function store_operand(e,t,n){switch(e){case 0:return;case 1:MemW4(t,n);return;case 2:frame.locals[t]=n;return;case 3:frame.valstack.push(n);return;default:fatal_error("Unrecognized desttype in callstub.",e)}}function store_operand_by_funcop(e,t){if(!e)return;switch(e.mode){case 8:frame.valstack.push(t);return;case 0:return;case 11:e.argsize==4?frame.locals[e.addr]=t:e.argsize==2?frame.locals[e.addr]=65535&t:frame.locals[e.addr]=255&t;return;case 15:e.argsize==4?MemW4(e.addr,t):e.argsize==2?MemW2(e.addr,t):MemW1(e.addr,t);return;default:fatal_error("Unknown addressing mode in store func by operand.")}}function set_random(e){e==0?random_func=Math.random:(srand_set_seed(e),random_func=srand_get_random)}function srand_set_seed(e){var t,n,r,i,s;srand_table===undefined&&(srand_table=Array(55)),srand_table[54]=e,srand_index1=0,srand_index2=31,r=1;for(t=0;t<55;t++)n=21*t%55,srand_table[n]=r,r=e-r>>>0,e=srand_table[n];for(s=0;s<4;s++)for(t=0;t<55;t++)i=srand_table[t]-srand_table[(1+t+30)%55],srand_table[t]=i>>>0}function srand_get_random(){return srand_index1=(srand_index1+1)%55,srand_index2=(srand_index2+1)%55,srand_table[srand_index1]=srand_table[srand_index1]-srand_table[srand_index2]>>>0,srand_table[srand_index1]/4294967296}function accel_helper_obj_in_class(e){return Mem4(e+13+accel_params[7])==accel_params[2]}function accel_helper_get_prop(e,t){var n=0,r;if(t&4294901760){n=Mem4(accel_params[0]+(t&65535)*4),accel_helper_temp_args[0]=e,accel_helper_temp_args[1]=n;if(accel_func_map[5](2,accel_helper_temp_args)==0)return 0;t>>=16,e=n}accel_helper_temp_args[0]=e,accel_helper_temp_args[1]=t,r=accel_func_map[2](2,accel_helper_temp_args);if(r==0)return 0;if(accel_helper_obj_in_class(e)&&n==0)if(t<accel_params[1]||t>=accel_params[1]+8)return 0;return Mem4(accel_params[6])!=e&&Mem1(r+9)&1?0:r}function set_string_table(e){if(stringtable==e)return;decoding_tree=undefined,vmstring_table=undefined,stringtable=e;if(stringtable==0)return;var t=vmtextenv_table[stringtable];if(t===undefined){var n=undefined,r=Mem4(stringtable),i=Mem4(stringtable+8),s=stringtable+r<=ramstart;if(s){var o=Array(1);build_decoding_tree(o,i,4,0),n=o[0],n===undefined&&fatal_error("Failed to create decoding tree.")}t=new VMTextEnv(stringtable,n),vmtextenv_table[stringtable]=t}decoding_tree=t.decoding_tree,vmstring_table=t.vmstring_tables[iosysmode]}function set_iosys(e,t){switch(e){case 0:t=0;break;case 1:break;case 2:t=0;break;default:e=0,t=0}iosysmode=e,iosysrock=t;var n=vmtextenv_table[stringtable];n===undefined?vmstring_table=undefined:vmstring_table=n.vmstring_tables[iosysmode]}function build_decoding_tree(e,t,n,r){var i,s,o,u;s=Mem1(t);if(s==0&&n==4){o=Array(16),o.type=0,o.depth=4,e[r]=o,build_decoding_tree(o,t,0,0);return}if(s==0){var a=Mem4(t+1),f=Mem4(t+5);build_decoding_tree(e,a,n+1,r),build_decoding_tree(e,f,n+1,r|1<<n);return}t++,o={},o.type=s,o.depth=n;switch(s){case 2:o.value=Mem1(t),o.cchar=CharToString(o.value);break;case 4:o.value=Mem4(t),o.cchar=CharToString(o.value);break;case 3:case 5:o.addr=t;break;case 8:case 9:o.addr=Mem4(t);break;case 10:case 11:o.addr=t;break;case 1:break;default:fatal_error("Unknown node type in string table.",s)}u=1<<n;for(i=r;i<16;i+=u)e[i]=o}function stream_num(e,t,n,r){var i=(t&4294967295).toString(10);switch(iosysmode){case 2:r&&(i=i.slice(r)),Glk.glk_put_jstring(i,!0);break;case 1:n||(frame.valstack.push(17,0,e,frame.framestart),n=!0);if(r<i.length){var s=i.charCodeAt(r);return frame.valstack.push(18,r+1,t,frame.framestart),tempcallargs[0]=s,enter_function(iosysrock,1),!0}break;case 0:}if(n){var o,u;frame.valstack.pop()!=frame.framestart&&fatal_error("Call stub frameptr does not match frame."),pc=frame.valstack.pop(),u=frame.valstack.pop(),o=frame.valstack.pop(),o!=17&&fatal_error("String-on-string call stub while printing number.")}}function stream_string(e,t,n,r){var i=n!=0,s,o,u,a,f;for(;;){o=undefined,n==0?s=t:s=t+"/"+n+"/"+r,vmstring_table!==undefined&&t<ramstart?(o=vmstring_table[s],o===undefined&&(o=compile_string(iosysmode,t,n,r),vmstring_table[s]=o,strings_compiled++,strings_cached++)):(o=compile_string(iosysmode,t,n,r),strings_compiled++);if(o instanceof Function){u=o(e,i);if(u instanceof Array){i=!0,t=u[0],n=u[1],r=u[2];continue}if(u)return!0}else{Glk.glk_put_jstring(o);if(!i)return!1}frame.valstack.pop()!=frame.framestart&&fatal_error("Call stub frameptr does not match frame."),pc=frame.valstack.pop(),f=frame.valstack.pop(),a=frame.valstack.pop();if(a==17)return!0;a==16?(i=!0,r=f,n=225,t=pc):fatal_error("Function-terminator call stub at end of string.")}}function compile_string(e,t,n,r){var i=t,s=r,o=undefined,u,a;i||fatal_error("Called compile_string with null address.");var f={startaddr:t,startbitnum:r,buffer:[],code:[]};n==0?(a=Mem1(i),a==226?i+=4:i++,s=0):a=n;if(a==225)if(decoding_tree){var l,c,h,p,d,v,m=!1;l=Mem1(i),s&&(l>>=s),c=8-s,h=!1,decoding_tree instanceof Array||(m=!0),d=decoding_tree;while(!m){if(c<4){var g=Mem1(i+1);l|=g<<c,c+=8,h=!0}v=d[l&15],c-=v.depth,l>>=v.depth,s+=v.depth;if(s>=8){i+=1,s-=8;if(h)h=!1;else{var g=Mem1(i);l|=g<<c,c+=8}}if(v instanceof Array){d=v;continue}switch(v.type){case 1:m=!0;break;case 2:case 4:switch(e){case 2:f.buffer.push(v.cchar);break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),f.code.push("tempcallargs[0]="+v.value+";"),f.code.push("enter_function(iosysrock, 1);"),o=!0,m=!0}d=decoding_tree;break;case 3:switch(e){case 2:p=v.addr;for(;;){u=Mem1(p);if(u==0)break;f.buffer.push(CharToString(u)),p++}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),o="["+v.addr+", 0xE0, 0]",m=!0}d=decoding_tree;break;case 5:switch(e){case 2:p=v.addr;for(;;){u=Mem4(p);if(u==0)break;f.buffer.push(CharToString(u)),p+=4}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),o="["+v.addr+", 0xE2, 0]",m=!0}d=decoding_tree;break;case 8:case 9:case 10:case 11:oputil_flush_string(f),oputil_push_substring_callstub(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+v.addr+";"),v.type>=9&&f.code.push("oaddr = Mem4(oaddr);"),v.type==11&&f.code.push("oaddr = Mem4(oaddr);"),f.code.push("otype = Mem1(oaddr);"),o="retval",m=!0,oputil_push_callstub(f,"0x10,"+s,i),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var y=0;if(v.type==10||v.type==11){y=Mem4(v.addr+4);for(var b=0;b<y;b++)f.code.push("tempcallargs["+b+"]="+Mem4(v.addr+8+4*b)+";")}f.code.push("enter_function(oaddr, "+y+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:fatal_error("Unknown entity in string decoding (cached).")}}}else{var w,E,S,m=!1;stringtable||fatal_error("Attempted to print a compressed string with no table set."),E=Mem1(i),s&&(E>>=s),w=Mem4(stringtable+8);while(!m){S=Mem1(w),w++;switch(S){case 0:E&1?w=Mem4(w+4):w=Mem4(w+0),s==7?(s=0,i++,E=Mem1(i)):(s++,E>>=1);break;case 1:o=!1,m=!0;break;case 2:u=Mem1(w);switch(e){case 2:f.buffer.push(CharToString(u));break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),f.code.push("tempcallargs[0]="+u+";"),f.code.push("enter_function(iosysrock, 1);"),o=!0,m=!0}w=Mem4(stringtable+8);break;case 4:u=Mem4(w);switch(e){case 2:f.buffer.push(CharToString(u));break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),f.code.push("tempcallargs[0]="+u+";"),f.code.push("enter_function(iosysrock, 1);"),o=!0,m=!0}w=Mem4(stringtable+8);break;case 3:switch(e){case 2:for(;;){u=Mem1(w);if(u==0)break;f.buffer.push(CharToString(u)),w++}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),o="["+w+", 0xE0, 0]",m=!0}w=Mem4(stringtable+8);break;case 5:switch(e){case 2:for(;;){u=Mem4(w);if(u==0)break;f.buffer.push(CharToString(u)),w+=4}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),oputil_push_callstub(f,"0x10,"+s,i),o="["+w+", 0xE2, 0]",m=!0}w=Mem4(stringtable+8);break;case 8:case 9:case 10:case 11:oputil_flush_string(f),oputil_push_substring_callstub(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+Mem4(w)+";"),(S==9||S==11)&&f.code.push("oaddr = Mem4(oaddr);"),f.code.push("otype = Mem1(oaddr);"),o="retval",m=!0,oputil_push_callstub(f,"0x10,"+s,i),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var y=0;if(S==10||S==11){y=Mem4(w+4);for(var b=0;b<y;b++)f.code.push("tempcallargs["+b+"]="+Mem4(w+8+4*b)+";")}f.code.push("enter_function(oaddr, "+y+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:fatal_error("Unknown entity in string decoding.",S)}}}else if(a==224){var u;switch(e){case 2:for(;;){u=Mem1(i),i++;if(u==0)break;f.buffer.push(CharToString(u))}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),u=Mem1(i),i++,u!=0?(oputil_push_callstub(f,"0x13,0",i),f.code.push("tempcallargs[0]="+u+";"),f.code.push("enter_function(iosysrock, 1);"),o=!0):o="false"}}else if(a==226){var u;switch(e){case 2:for(;;){u=Mem4(i),i+=4;if(u==0)break;f.buffer.push(CharToString(u))}break;case 1:oputil_flush_string(f),oputil_push_substring_callstub(f),u=Mem4(i),i+=4,u!=0?(oputil_push_callstub(f,"0x14,0",i),f.code.push("tempcallargs[0]="+u+";"),f.code.push("enter_function(iosysrock, 1);"),o=!0):o="false"}}else a>=224&&a<=255?fatal_error("Attempt to print unknown type of string."):fatal_error("Attempt to print non-string.");return o?(oputil_flush_string(f),f.code.push("return "+o+";"),make_code(f.code.join("\n"),"nextcp,substring")):f.buffer.join("")}function do_gestalt(e,t){var n;switch(e){case 0:return 196866;case 1:return 66304;case 2:return 1;case 3:return 1;case 4:switch(t){case 0:return 1;case 1:return 1;case 2:return 1;default:return 0}break;case 5:return 1;case 6:return 1;case 7:return 1;case 8:return heap_get_start();case 9:return 1;case 10:return accel_func_map[t]?1:0;case 11:return 1;default:return 0}}function fetch_search_key(e,t,n){var r;tempsearchkey.length=t;if(n&1)for(r=0;r<t;r++)tempsearchkey[r]=Mem1(e+r);else switch(t){case 4:tempsearchkey[0]=e>>24&255,tempsearchkey[1]=e>>16&255,tempsearchkey[2]=e>>8&255,tempsearchkey[3]=e&255;break;case 2:tempsearchkey[0]=e>>8&255,tempsearchkey[1]=e&255;break;case 1:tempsearchkey[0]=e&255;break;default:throw"Direct search key must hold one, two, or four bytes."}return tempsearchkey}function linear_search(e,t,n,r,i,s,o){var u,a,f,l,c=(o&4)!=0,h=(o&2)!=0,p=fetch_search_key(e,t,o);for(a=0;a<i;a++,n+=r){f=!0;for(u=0;f&&u<t;u++)l=Mem1(n+s+u),l!=p[u]&&(f=!1);if(f)return c?a:n;if(h){f=!0;for(u=0;f&&u<t;u++)l=Mem1(n+s+u),l!=0&&(f=!1);if(f)break}}return c?4294967295:0}function binary_search(e,t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v=(o&4)!=0,m=fetch_search_key(e,t,o);a=0,u=i;while(a<u){c=0,l=u+a>>1,f=n+l*r;for(h=0;!c&&h<t;h++)p=Mem1(f+s+h),d=m[h],p<d?c=-1:p>d&&(c=1);if(!c)return v?l:f;c<0?a=l+1:u=l}return v?4294967295:0}function linked_search(e,t,n,r,i,s){var o,u,a,f=(s&2)!=0,l=fetch_search_key(e,t,s);while(n!=0){a=!0;for(o=0;a&&o<t;o++)u=Mem1(n+r+o),u!=l[o]&&(a=!1);if(a)return n;if(f){a=!0;for(o=0;a&&o<t;o++)u=Mem1(n+r+o),u!=0&&(a=!1);if(a)break}n=Mem4(n+i)}return 0}function decode_float(e){var t,n,r;return e&2147483648?(t=!0,e&=2147483647):t=!1,e==0?t?0:0:(e&2139095040)==2139095040?(e&8388607)==0?t?-Infinity:Infinity:t?-NaN:NaN:(r=e>>23&255,r?n=(e&8388607|8388608)/8388608*Math.pow(2,r-127):n=(e&8388607)/8388608*Math.pow(2,-126),t?-n:n)}function encode_float(e){var t,n,r,i,s;if(isNaN(e))return 2139095041;if(!isFinite(e))return e<0?4286578688:2139095040;if(e==0)return 1/e<0?2147483648:0;e<0?(s=!0,t=-e):(s=!1,t=e),i=Math.floor(Math.log(t)/Math.log(2)),r=t/Math.pow(2,i);if(i>=128)return s?4286578688:2139095040;if(i<-126)r*=Math.pow(2,126+i),i=0;else if(i!=0||r!=0)i+=127,r-=1;r*=8388608,n=r+.4999999999999999<<0;if(n>=8388608){n=0,i++;if(i>=255)return s?4286578688:2139095040}return s?(2147483648|i<<23|n)>>>0:i<<23|n}function setup_vm(){var e,t;game_image||fatal_error("There is no Glulx game file loaded."),vm_started=!0,resumefuncop=null,resumevalue=0,memmap=null,stack=[],frame=null,pc=0,game_image.length<36&&fatal_error("This is too short to be a valid Glulx file."),e=ByteRead4(game_image,0),e!=1198290284&&fatal_error("This is not a valid Glulx file."),t=ByteRead4(game_image,4),t<131072&&fatal_error("This Glulx file is too old a version to execute."),t>=197120&&fatal_error("This Glulx file is too new a version to execute."),ramstart=ByteRead4(game_image,8),endgamefile=ByteRead4(game_image,12),origendmem=ByteRead4(game_image,16),stacksize=ByteRead4(game_image,20),startfuncaddr=ByteRead4(game_image,24),origstringtable=ByteRead4(game_image,28),checksum=ByteRead4(game_image,32),protectstart=0,protectend=0,(ramstart<256||endgamefile<ramstart||origendmem<endgamefile)&&fatal_error("The segment boundaries in the header are in an impossible order."),endgamefile!=game_image.length&&fatal_error("The game file length does not agree with the header."),done_executing=!1,vmfunc_table={},vmtextenv_table={},decoding_tree=undefined,vmstring_table=undefined,tempcallargs=Array(8),tempglkargs=Array(1),set_random(0),endmem=origendmem,stringtable=0,undostack=[],heapstart=0,usedlist=[],freelist=[],vm_restart()}function vm_restart(){var e;heap_clear();var t=copy_protected_range();memmap=null,memmap=game_image.slice(0,endgamefile),endmem=memmap.length,change_memsize(origendmem,!1),paste_protected_range(t),stack=[],frame=null,pc=0,iosysmode=0,iosysrock=0,set_string_table(origstringtable),enter_function(startfuncaddr,0)}function compress_bytes(e){result=[];var t=0;while(t<e.length){var n=0;while(t<e.length&&e[t]==0&&n<=255)n++,t++;n>0&&(result.push(0),result.push(n-1));while(t<e.length&&e[t]!=0)result.push(e[t]),t++}return result}function decompress_bytes(e){result=[];var t=0;while(t<e.length){var n=e[t++];if(n==0){var r=e[t++]+1;for(var i=0;i<r;i++)result.push(0)}else result.push(n)}return result}function pack_iff_chunks(e){keys=[];for(var t in e)t.length!=4&&fatal_error("Bad chunk ID (must be exactly 4 chars): "+t),keys.push(t);keys.sort(),bytes=[];for(var n=0;n<keys.length;n++){var t=keys[n],r=e[t];BytePushString(bytes,t),BytePush4(bytes,r.length),bytes=bytes.concat(r)}return bytes}function unpack_iff_chunks(e){chunks={};var t=0;while(t<e.length){if(t+8>e.length)return qlog("IFF chunk header is truncated"),undefined;var n=ByteReadString(e,t,4),r=ByteRead4(e,t+4);t+=8;if(t+r>e.length)return qlog(n+" chunk is truncated ("+r+" bytes needed, "+(e.length-t)+" available"),undefined;chunks[n]=e.slice(t,t+r),t+=r}return chunks}function vm_save(e){iosysmode!=2&&fatal_error("Streams are only available in Glk I/O system.");var t=GiDispa.class_obj_from_id("stream",e);if(!t)return!1;chunks={},chunks.IFhd=game_image.slice(0,128);var n=memmap.slice(ramstart);for(var r=ramstart;r<game_image.length;r++)n[r-ramstart]^=game_image[r];n=compress_bytes(n),n.splice(0,0,0,0,0,0),ByteWrite4(n,0,endmem),chunks.CMem=n,chunks.Stks=[];for(var r=0;r<stack.length;r++)push_serialized_stackframe(stack[r],chunks.Stks);if(heap_is_active()){chunks.MAll=[],BytePush4(chunks.MAll,heapstart),BytePush4(chunks.MAll,usedlist.length);for(var r=0;r<usedlist.length;r++)BytePush4(chunks.MAll,usedlist[r].addr),BytePush4(chunks.MAll,usedlist[r].size)}var i=[];BytePushString(i,"IFZS"),i=i.concat(pack_iff_chunks(chunks));var s=pack_iff_chunks({FORM:i});return Glk.glk_put_buffer_stream(t,s),!0}function vm_restore(e){iosysmode!=2&&fatal_error("Streams are only available in Glk I/O system.");var t=GiDispa.class_obj_from_id("stream",e);if(!t)return!1;var n=new Array(0),r=new Array(1024),i=1;while(i>0)i=Glk.glk_get_buffer_stream(t,r),n=n.concat(r.slice(0,i));n=unpack_iff_chunks(n);if(!n)return qlog("vm_restore failed: file is not Quetzal"),!1;n=n.FORM;if(!n||ByteReadString(n,0,4)!="IFZS")return qlog("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var s=unpack_iff_chunks(n.slice(4));if(!s.IFhd)return qlog("vm_restore failed: missing required IFhd chunk"),!1;for(var o=0;o<128;o++)if(s.IFhd[o]!=game_image[o])return qlog("vm_restore failed: this save image is for a different game"),!1;if(!s.CMem)return qlog("vm_restore failed: missing required CMem chunk"),!1;if(!s.Stks)return qlog("vm_restore failed: missing required Stks chunk"),!1;var u=copy_protected_range();heap_clear();var a=ByteRead4(s.CMem,0),f=s.CMem.slice(4);f=decompress_bytes(f);while(f.length<a-ramstart)f.push(0);change_memsize(a,!1),memmap=game_image.slice(0,ramstart).concat(f);for(var o=ramstart;o<game_image.length;o++)memmap[o]^=game_image[o];var l=s.Stks;stack=[];while(l.length)frame=pop_deserialized_stackframe(l),frame||fatal_error("vm_restore failed: bad stack frame"),stack.unshift(frame);for(var o=0;o<stack.length;o++)stack[o].depth=o;frame=stack[stack.length-1];var c=s.MAll;if(c&&c.length>=8){heapstart=ByteRead4(c,0);var h=ByteRead4(c,4);for(var o=0;o<h;o++){var p=ByteRead4(c,8+8*o),d=ByteRead4(c,12+8*o);usedlist.push(new HeapBlock(p,d))}usedlist.sort(function(e,t){return e.addr-t.addr});var v=heapstart;for(var o=0;o<usedlist.length;o++){var p=usedlist[o].addr,d=usedlist[o].size;(p<v||p+d>endmem)&&fatal_error("vm_restore failed: corrupt dynamic heap"),p>v&&freelist.push(new HeapBlock(v,p-v)),v=p+d}v<endmem&&freelist.push(new HeapBlock(v,endmem-v))}return paste_protected_range(u),!0}function vm_saveundo(){var e={};e.ram=memmap.slice(ramstart),e.endmem=endmem,e.pc=pc,e.stack=[];for(var t=0;t<stack.length;t++)e.stack[t]=clone_stackframe(stack[t]);e.heapstart=heapstart,e.usedlist=usedlist.slice(0),e.freelist=freelist.slice(0),undostack.push(e),undostack.length>10&&undostack.shift()}function vm_restoreundo(){if(undostack.length==0)return!1;var e=undostack.pop(),t=copy_protected_range();return memmap=memmap.slice(0,ramstart).concat(e.ram),endmem=e.endmem,stack=e.stack,frame=stack[stack.length-1],pc=e.pc,heapstart=e.heapstart,usedlist=e.usedlist,freelist=e.freelist,paste_protected_range(t),!0}function change_memsize(e,t){var n;if(e==endmem)return;!t&&heap_is_active()&&fatal_error("Cannot resize Glulx memory space while heap is active."),e<origendmem&&fatal_error("Cannot resize Glulx memory space smaller than it started."),e&255&&fatal_error("Can only resize Glulx memory space to a 256-byte boundary."),memmap.length=e;if(e>endmem)for(n=endmem;n<e;n++)memmap[n]=0;endmem=e}function copy_protected_range(){if(protectstart>=protectend)return null;var e=protectend-protectstart,t={start:protectstart,end:protectend,len:e},n=memmap.slice(protectstart,protectend);while(n.length<e)n.push(0);return t.mem=n,t}function paste_protected_range(e){if(!e)return;var t,n,r=e.mem,i=e.start,s=e.end;s>endmem&&(s=endmem);for(t=0,n=i;n<s;t++,n++)memmap[n]=r[t]}function perform_verify(){var e=game_image.length,t,n,r;if(e<256||(e&255)!=0)return 1;if(e!=ByteRead4(game_image,12))return 1;r=ByteRead4(game_image,32),n=-r>>>0;for(t=0;t<e;t+=4)n=n+ByteRead4(game_image,t)>>>0;return n!=r?1:0}function quixe_get_signature(){return game_signature}function quixe_get_statistics(){var e={game_image_length:game_image.length,total_execution_time:total_execution_time,total_function_calls:total_function_calls,accel_function_calls:accel_function_calls,total_path_calls:total_path_calls,paths_cached:paths_cached,paths_compiled:paths_compiled,strings_cached:strings_cached,strings_compiled:strings_compiled};return e}function heap_clear(){heapstart=0,usedlist=[],freelist=[]}function heap_is_active(){return usedlist.length>0}function heap_get_start(){return heapstart}function HeapBlock(e,t){this.addr=e,this.size=t,this.end=e+t}function heap_binary_search(e,t){var n=0,r=e.length;while(n<r){var i=n+r>>1;e[i].addr<t?n=i+1:r=i}return n}function heap_malloc(e){heap_is_active()||(heapstart=endmem);for(var t=0,n=freelist.length;t<n;t++){var r=freelist[t];if(r.size>=e){r.size>e?freelist[t]=new HeapBlock(r.addr+e,r.size-e):freelist.splice(t,1);var i=heap_binary_search(usedlist,r.addr);return usedlist.splice(i,0,new HeapBlock(r.addr,e)),r.addr}}var s=endmem,o=e+255&4294967040;return change_memsize(endmem+o,!0),o>e&&freelist.push(new HeapBlock(s+e,o-e)),usedlist.push(new HeapBlock(s,e)),s}function heap_free(e){var t=heap_binary_search(usedlist,e),n=usedlist[t];(!n||n.addr!=e)&&fatal_error("Tried to free non-existent block"),usedlist.splice(t,1);if(usedlist.length==0){change_memsize(heapstart,!0),heap_clear();return}t=heap_binary_search(freelist,e);var r=freelist[t];r&&r.addr==n.end&&(n=new HeapBlock(e,n.size+r.size),freelist.splice(t,1));var i=freelist[t-1];i&&i.end==n.addr&&(n=new HeapBlock(i.addr,i.size+n.size),freelist.splice(t-1,1),t-=1),freelist.splice(t,0,n)}function assert_heap_valid(){if(!heap_is_active()){heapstart!=0&&fatal_error("Heap inconsistency: heapstart nonzero"),usedlist.length>0&&fatal_error("Heap inconsistency: usedlist nonempty"),freelist.length>0&&fatal_error("Heap inconsistency: usedlist nonempty");return}heapstart==0&&fatal_error("Heap inconsistency: heapstart is zero");var e=heapstart,t=0,n=0;while(t<usedlist.length||n<freelist.length){var r=usedlist[t],i=freelist[n];r&&r.addr==e?(e+=r.size,t++):i&&i.addr==e?(e+=i.size,n++):fatal_error("Heap inconsistency: no block at address "+e)}e!=endmem&&fatal_error("Heap inconsistency: overrun at end of heap")}function quixe_get_debuginfo(){return debuginfo}function parse_inform_debug_data(e){var t=GiLoad.find_data_chunk(e);if(!t)return;var n=t.data,r,i,s;if(n[0]!=222||n[1]!=191||n[2]!=0||n[3]!=0)return;var o=n[4]<<8|n[5];i=6,r=!1;while(!r){var u=n[i++];switch(u){case 0:case undefined:r=!0;break;case 1:var a=n[i++];s=i;while(n[i])i++;var f=String.fromCharCode.apply(this,n.slice(s,i));i++,s=i;while(n[i])i++;var l=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 2:s=i;while(n[i])i++;var c=String.fromCharCode.apply(this,n.slice(s,i));i++;var h=n.slice(i,i+4);i+=4;var p=n.slice(i,i+4);i+=4;break;case 3:var d=n[i++]<<8|n[i++];s=i;while(n[i])i++;var v=String.fromCharCode.apply(this,n.slice(s,i));i++;var h=n.slice(i,i+4);i+=4;var p=n.slice(i,i+4);i+=4;break;case 4:var m=n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 5:var m=n[i++]<<8|n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 6:var m=n[i++]<<8|n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 7:var m=n[i++]<<8|n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 8:var m=n[i++]<<8|n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 9:i+=64;break;case 10:var y=n[i++]<<8|n[i++],b=n[i++]<<8|n[i++];i+=b*6;break;case 11:var y=n[i++]<<8|n[i++],w=n.slice(i,i+4);i+=4;var E=n[i++]<<16|n[i++]<<8|n[i++];s=i;while(n[i])i++;var S=String.fromCharCode.apply(this,n.slice(s,i));i++;var x=[];while(n[i]){s=i;while(n[i])i++;var T=String.fromCharCode.apply(this,n.slice(s,i));i++,x.push(T)}i++,debuginfo.functions.push({num:y,name:S,addr:E,locals:x});break;case 12:var N=n[i++]<<8|n[i++];s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;break;case 13:while(n[i]){s=i;while(n[i])i++;var g=String.fromCharCode.apply(this,n.slice(s,i));i++;var C=n[i++]<<16|n[i++]<<8|n[i++];debuginfo.map[g]=C}i++;break;case 14:var y=n[i++]<<8|n[i++],w=n.slice(i,i+4);i+=4;var k=n[i++]<<16|n[i++]<<8|n[i++];break;default:qlog("Unknown record type in debug data: "+u),r=!0}}var L=debuginfo.map["code area"];if(L){var A;for(A=0;A<debuginfo.functions.length;A++){var O=debuginfo.functions[A];debuginfo.functionmap[L+O.addr]=O}}}function execute_loop(){var e,t,n,r,i;resumefuncop&&(store_operand_by_funcop(resumefuncop,resumevalue),resumefuncop=null,resumevalue=0),r=(new Date).getTime();while(!done_executing){e=frame.vmfunc,t=e[iosysmode],n=t[pc],n===undefined&&(e.pathaddrs[pc]=!0,n=compile_path(e,pc,iosysmode),paths_compiled++,pc<ramstart&&(t[pc]=n,paths_cached++)),total_path_calls++;try{n()}catch(s){if(s!==ReturnedFromMain)throw s;done_executing=!0,vm_stopped=!0}}i=(new Date).getTime(),total_execution_time+=(i-r)/1e3,vm_stopped&&Glk.glk_exit(),Glk.update(),qlog("### done executing; path time = "+(i-r)+" ms")}var bytestring_table=Array(256),quotechar_table=Array(256),regexp_string_unsafe=/[^a-zA-Z0-9 .,;:?!=_+()-]/g,operandlist_table=null,funcop_cache={},opcode_table={0:function(e,t){},16:function(e,t){e.code.push(t[2]+"(("+t[0]+")+("+t[1]+")) >>>0);")},17:function(e,t){e.code.push(t[2]+"(("+t[0]+")-("+t[1]+")) >>>0);")},18:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]);e.code.push(t[2]+"(("+n+")*("+r+")) >>>0);")},19:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]),i=alloc_holdvar(e);e.code.push(i+"=(("+n+")/("+r+"));"),e.code.push("if (!isFinite("+i+")) fatal_error('Division by zero.');"),e.code.push(t[2]+"("+i+">=0)?Math.floor("+i+"):(-Math.floor(-"+i+") >>>0));")},20:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]),i=alloc_holdvar(e);e.code.push(i+"=(("+n+")%("+r+"));"),e.code.push("if (!isFinite("+i+")) fatal_error('Modulo division by zero.');"),e.code.push(t[2]+i+" >>>0);")},21:function(e,t){e.code.push(t[1]+"(-("+t[0]+")) >>>0);")},24:function(e,t){e.code.push(t[2]+"(("+t[0]+")&("+t[1]+")) >>>0);")},25:function(e,t){e.code.push(t[2]+"(("+t[0]+")|("+t[1]+")) >>>0);")},26:function(e,t){e.code.push(t[2]+"(("+t[0]+")^("+t[1]+")) >>>0);")},27:function(e,t){e.code.push(t[1]+"(~("+t[0]+")) >>>0);")},28:function(e,t){if(quot_isconstant(t[1])){var n=Number(t[1]);n<32?e.code.push(t[2]+"(("+t[0]+")<<"+n+") >>>0);"):e.code.push(t[2]+"0);")}else e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+"<<"+t[1]+") >>>0) : 0);")},29:function(e,t){if(quot_isconstant(t[1])){var n=Number(t[1]);n<32?e.code.push(t[2]+"(("+t[0]+")>>"+n+") >>>0);"):e.code.push(t[2]+"(("+t[0]+")&0x80000000) ? 0xffffffff : 0);")}else e.code.push("if ("+t[0]+" & 0x80000000) {"),e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+">>"+t[1]+") >>>0) : 0xffffffff);"),e.code.push("} else {"),e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+">>"+t[1]+") >>>0) : 0);"),e.code.push("}")},30:function(e,t){if(quot_isconstant(t[1])){var n=Number(t[1]);n<32?e.code.push(t[2]+"("+t[0]+")>>>"+n+");"):e.code.push(t[2]+"0);")}else e.code.push(t[2]+"("+t[1]+"<32) ? ("+t[0]+">>>"+t[1]+") : 0);")},32:function(e,t){oputil_perform_jump(e,t[0],!0),e.path_ends=!0},260:function(e,t){if(quot_isconstant(t[0])){var n=Number(t[0]);e.code.push("pc = "+n+";"),e.vmfunc.pathaddrs[n]=!0}else e.code.push("pc = "+t[0]+";");oputil_unload_offstate(e),e.code.push("return;"),e.path_ends=!0},34:function(e,t){e.code.push("if (("+t[0]+")==0) {"),oputil_perform_jump(e,t[1]),e.code.push("}")},35:function(e,t){e.code.push("if (("+t[0]+")!=0) {"),oputil_perform_jump(e,t[1]),e.code.push("}")},36:function(e,t){e.code.push("if (("+t[0]+")==("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},37:function(e,t){e.code.push("if (("+t[0]+")!=("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},38:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]);e.code.push("if (("+n+")<("+r+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},39:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]);e.code.push("if (("+n+")>=("+r+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},40:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]);e.code.push("if (("+n+")>("+r+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},41:function(e,t){var n=oputil_signify_operand(e,t[0]),r=oputil_signify_operand(e,t[1]);e.code.push("if (("+n+")<=("+r+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},42:function(e,t){e.code.push("if (("+t[0]+")<("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},43:function(e,t){e.code.push("if (("+t[0]+")>=("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},44:function(e,t){e.code.push("if (("+t[0]+")>("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},45:function(e,t){e.code.push("if (("+t[0]+")<=("+t[1]+")) {"),oputil_perform_jump(e,t[2]),e.code.push("}")},48:function(e,t){if(quot_isconstant(t[1])){var n,r=Number(t[1]);for(n=0;n<r;n++)if(e.offstack.length){var i=pop_offstack_holdvar(e);e.code.push("tempcallargs["+n+"]="+i+";")}else e.code.push("tempcallargs["+n+"]=frame.valstack.pop();");oputil_unload_offstate(e)}else e.varsused.ix=!0,oputil_unload_offstate(e),e.code.push("for (ix=0; ix<"+t[1]+"; ix++) { tempcallargs[ix]=frame.valstack.pop(); }");oputil_push_callstub(e,t[2]),e.code.push("enter_function("+t[0]+", "+t[1]+");"),e.code.push("return;"),e.path_ends=!0},52:function(e,t){if(quot_isconstant(t[1])){var n,r=Number(t[1]);for(n=0;n<r;n++)if(e.offstack.length){var i=pop_offstack_holdvar(e);e.code.push("tempcallargs["+n+"]="+i+";")}else e.code.push("tempcallargs["+n+"]=frame.valstack.pop();");oputil_unload_offstate(e)}else e.varsused.ix=!0,oputil_unload_offstate(e),e.code.push("for (ix=0; ix<"+t[1]+"; ix++) { tempcallargs[ix]=frame.valstack.pop(); }");e.code.push("leave_function();"),e.code.push("enter_function("+t[0]+", "+t[1]+");"),e.code.push("return;"),e.path_ends=!0},352:function(e,t){oputil_unload_offstate(e),oputil_push_callstub(e,t[1]),e.code.push("enter_function("+t[0]+", 0);"),e.code.push("return;"),e.path_ends=!0},353:function(e,t){oputil_unload_offstate(e),e.code.push("tempcallargs[0]=("+t[1]+");"),oputil_push_callstub(e,t[2]),e.code.push("enter_function("+t[0]+", 1);"),e.code.push("return;"),e.path_ends=!0},354:function(e,t){oputil_unload_offstate(e),e.code.push("tempcallargs[0]=("+t[1]+");"),e.code.push("tempcallargs[1]=("+t[2]+");"),oputil_push_callstub(e,t[3]),e.code.push("enter_function("+t[0]+", 2);"),e.code.push("return;"),e.path_ends=!0},355:function(e,t){oputil_unload_offstate(e),e.code.push("tempcallargs[0]=("+t[1]+");"),e.code.push("tempcallargs[1]=("+t[2]+");"),e.code.push("tempcallargs[2]=("+t[3]+");"),oputil_push_callstub(e,t[4]),e.code.push("enter_function("+t[0]+", 3);"),e.code.push("return;"),e.path_ends=!0},49:function(e,t){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("leave_function();"),e.code.push("pop_callstub("+t[0]+");"),e.code.push("return;"),e.path_ends=!0},50:function(e,t){oputil_unload_offstate(e),oputil_push_callstub(e,t[0]),e.code.push("store_operand("+t[0]+",frame.framestart+frame.framelen+4*frame.valstack.length);"),oputil_perform_jump(e,t[1],!0),e.path_ends=!0},51:function(e,t){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("pop_stack_to("+t[1]+");"),e.code.push("pop_callstub("+t[0]+");"),e.code.push("return;"),e.path_ends=!0},64:function(e,t){oputil_store(e,t[1],t[0])},65:function(e,t){oputil_store(e,t[1],t[0])},66:function(e,t){oputil_store(e,t[1],t[0])},68:function(e,t){var n;quot_isconstant(t[0])?(n=Number(t[0]),n=n&32768?(n|4294901760)>>>0:n&65535,e.code.push(t[1]+n+");")):e.code.push(t[1]+"("+t[0]+" & 0x8000) ? (("+t[0]+" | 0xffff0000) >>> 0) : ("+t[0]+" & 0xffff));")},69:function(e,t){var n;quot_isconstant(t[0])?(n=Number(t[0]),n=n&128?(n|4294967040)>>>0:n&255,e.code.push(t[1]+n+");")):e.code.push(t[1]+"("+t[0]+" & 0x80) ? (("+t[0]+" | 0xffffff00) >>> 0) : ("+t[0]+" & 0xff));")},72:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1])*4,n="Mem4("+(r>>>0)+")";else{var r=Number(t[1])*4;r?n="Mem4(("+t[0]+"+"+r+") >>>0)":n="Mem4("+t[0]+")"}else n="Mem4(("+t[0]+"+4*"+t[1]+") >>>0)";e.code.push(t[2]+n+");")},73:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1])*2,n="Mem2("+(r>>>0)+")";else{var r=Number(t[1])*2;r?n="Mem2(("+t[0]+"+"+r+") >>>0)":n="Mem2("+t[0]+")"}else n="Mem2(("+t[0]+"+2*"+t[1]+") >>>0)";e.code.push(t[2]+n+");")},74:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1]),n="Mem1("+(r>>>0)+")";else{var r=Number(t[1]);r?n="Mem1(("+t[0]+"+"+r+") >>>0)":n="Mem1("+t[0]+")"}else n="Mem1(("+t[0]+"+"+t[1]+") >>>0)";e.code.push(t[2]+n+");")},76:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1])*4,n=(r>>>0)+",";else{var r=Number(t[1])*4;r?n="("+t[0]+"+"+r+") >>>0,":n=t[0]+","}else n="("+t[0]+"+4*"+t[1]+") >>>0,";e.code.push("MemW4("+n+t[2]+");")},77:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1])*2,n=(r>>>0)+",";else{var r=Number(t[1])*2;r?n="("+t[0]+"+"+r+") >>>0,":n=t[0]+","}else n="("+t[0]+"+2*"+t[1]+") >>>0,";e.code.push("MemW2("+n+t[2]+");")},78:function(e,t){var n,r;if(quot_isconstant(t[1]))if(quot_isconstant(t[0]))r=Number(t[0])+Number(t[1]),n=(r>>>0)+",";else{var r=Number(t[1]);r?n="("+t[0]+"+"+r+") >>>0,":n=t[0]+","}else n="("+t[0]+"+"+t[1]+") >>>0,";e.code.push("MemW1("+n+t[2]+");")},75:function(e,t){if(quot_isconstant(t[1])){var n,r,i;i=Number(t[1])&4294967295,n=i&7,quot_isconstant(t[0])?(r=Number(t[0]),i>=0?r+=i>>3:r-=1+(-1-i>>3)):i>=0?i<=7?r=t[0]:r=t[0]+"+"+(i>>3):r=t[0]+"-"+(1+(-1-i>>3)),e.code.push(t[2]+"(Mem1("+r+") & "+(1<<n)+")?1:0);")}else{e.varsused.bitx=!0,e.varsused.addrx=!0;var s=oputil_signify_operand(e,t[1],!0);e.code.push("bitx = "+s+"&7;"),e.code.push("if ("+s+">=0) addrx = "+t[0]+" + ("+s+">>3);"),e.code.push("else addrx = "+t[0]+" - (1+((-1-("+s+"))>>3));"),e.code.push(t[2]+"(Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(e,t){var n,r,i,s;if(quot_isconstant(t[1]))s=Number(t[1])&4294967295,n=s&7,quot_isconstant(t[0])?(r=Number(t[0]),s>=0?r+=s>>3:r-=1+(-1-s>>3)):s>=0?s<=7?r=t[0]:r=t[0]+"+"+(s>>3):r=t[0]+"-"+(1+(-1-s>>3)),i=1<<n;else{e.varsused.bitx=!0,e.varsused.addrx=!0;var o=oputil_signify_operand(e,t[1],!0);e.code.push("bitx = "+o+"&7;"),e.code.push("if ("+o+">=0) addrx = "+t[0]+" + ("+o+">>3);"),e.code.push("else addrx = "+t[0]+" - (1+((-1-("+o+"))>>3));"),r="addrx",i="(1<<bitx)"}quot_isconstant(t[2])?Number(t[2])?e.code.push("MemW1("+r+", Mem1("+r+") | "+i+");"):e.code.push("MemW1("+r+", Mem1("+r+") & ~("+i+"));"):(e.code.push("if ("+t[2]+") MemW1("+r+", Mem1("+r+") | "+i+");"),e.code.push("else MemW1("+r+", Mem1("+r+") & ~("+i+"));"))},80:function(e,t){var n,r=e.offstack.length;r?n="frame.valstack.length+"+r:n="frame.valstack.length",oputil_store(e,t[0],n)},81:function(e,t){var n;if(quot_isconstant(t[0])){var r=Number(t[0]);r<e.offstack.length?n=e.offstack[e.offstack.length-(r+1)]:n="frame.valstack[frame.valstack.length-"+(r+1-e.offstack.length)+"]"}else oputil_unload_offstate(e),n="frame.valstack[frame.valstack.length-("+t[0]+"+1)]";oputil_store(e,t[1],n)},82:function(e,t){var n,r;e.offstack.length<2&&transfer_to_offstack(e,2),r=e.offstack.length,n=e.offstack[r-1],e.offstack[r-1]=e.offstack[r-2],e.offstack[r-2]=n},83:function(e,t){oputil_unload_offstate(e),e.varsused.ix=!0,e.varsused.pos=!0,e.varsused.roll=!0,e.varsused.vals1=!0;var n=oputil_signify_operand(e,t[0],!0),r=oputil_signify_operand(e,t[1],!0);e.code.push("if ("+n+" > 0) {"),e.code.push("if ("+r+" > 0) {"),e.code.push("vals1 = "+r+" % "+n+";"),e.code.push("} else {"),e.code.push("vals1 = "+n+" - (-("+r+")) % "+n+";"),e.code.push("}"),e.code.push("if (vals1) {"),e.code.push("pos = frame.valstack.length - "+n+";"),e.code.push("roll = frame.valstack.slice(frame.valstack.length-vals1, frame.valstack.length).concat(frame.valstack.slice(pos, frame.valstack.length-vals1));"),e.code.push("for (ix=0; ix<"+n+"; ix++) { frame.valstack[pos+ix] = roll[ix]; }"),e.code.push("roll = undefined;"),e.code.push("}"),e.code.push("}")},84:function(e,t){oputil_unload_offstate(e);if(quot_isconstant(t[0])){var n,r,i=Number(t[0]);for(n=0;n<i;n++)r=alloc_holdvar(e,!0),e.offstack.push(r),e.code.push(r+"=frame.valstack[frame.valstack.length-"+(i-n)+"];")}else e.varsused.ix=!0,e.varsused.jx=!0,e.code.push("jx = frame.valstack.length-("+t[0]+");"),e.code.push("for (ix=0; ix<"+t[0]+"; ix++) { frame.valstack.push(frame.valstack[jx+ix]); }")},256:function(e,t){var n="do_gestalt(("+t[0]+"),("+t[1]+"))";e.code.push(t[2]+n+");")},257:function(e,t){e.code.push("fatal_error('User debugtrap encountered.', "+t[0]+");")},258:function(e,t){e.code.push(t[0]+"endmem);")},259:function(e,t){e.code.push("change_memsize("+t[0]+",false);"),e.code.push(t[1]+"0);")},272:function(e,t){var n;if(quot_isconstant(t[0])){var r=Number(t[0])&4294967295;r==0?n="(Math.floor(random_func() * 0x10000) | (Math.floor(random_func() * 0x10000) << 16)) >>>0":r>0?n="Math.floor(random_func() * "+r+")":n="-Math.floor(random_func() * "+ -r+")"}else{var i=oputil_signify_operand(e,t[0],!0),s=alloc_holdvar(e);n=s,e.code.push("if ("+i+" > 0)"),e.code.push(s+" = Math.floor(random_func() * "+i+");"),e.code.push("else if ("+i+" < 0)"),e.code.push(s+" = -Math.floor(random_func() * -"+i+");"),e.code.push("else"),e.code.push(s+" = (Math.floor(random_func() * 0x10000) | (Math.floor(random_func() * 0x10000) << 16)) >>>0;")}e.code.push(t[1]+n+");")},273:function(e,t){e.code.push("set_random("+t[0]+");")},288:function(e,t){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("done_executing = true; vm_stopped = true;"),e.code.push("return;"),e.path_ends=!0},289:function(e,t){e.code.push(t[0]+"perform_verify());")},290:function(e,t){e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("vm_restart();"),e.code.push("return;"),e.path_ends=!0},291:function(e,t){oputil_unload_offstate(e),e.varsused.ix=!0,oputil_push_callstub(e,t[1]),e.code.push("ix = vm_save("+t[0]+");"),e.code.push("pop_callstub(ix ? 0 : 1);"),e.code.push("return;"),e.path_ends=!0},292:function(e,t){oputil_unload_offstate(e),e.code.push("if (vm_restore("+t[0]+")) {"),e.code.push("pop_callstub((-1)>>>0);"),e.code.push("} else {"),oputil_store(e,t[1],"1"),oputil_unload_offstate(e),e.code.push("pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},293:function(e,t){oputil_unload_offstate(e),oputil_push_callstub(e,t[0]),e.code.push("vm_saveundo();"),e.code.push("pop_callstub(0);"),e.code.push("return;"),e.path_ends=!0},294:function(e,t){oputil_unload_offstate(e),e.code.push("if (vm_restoreundo()) {"),e.code.push("pop_callstub((-1)>>>0);"),e.code.push("} else {"),oputil_store(e,t[0],"1"),oputil_unload_offstate(e),e.code.push("pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},295:function(e,t){e.code.push("protectstart="+t[0]+";"),e.code.push("protectend=protectstart+("+t[1]+");"),e.code.push("if (protectstart==protectend) {"),e.code.push("  protectstart=0; protectend=0;"),e.code.push("}")},368:function(e,t){e.varsused.maddr=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+t[0]+";"),e.code.push("maddr="+t[1]+";"),e.code.push("for (ix=0; ix<mlen; ix++, maddr++) MemW1(maddr, 0);")},369:function(e,t){e.varsused.msrc=!0,e.varsused.mdest=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+t[0]+";"),e.code.push("msrc="+t[1]+";"),e.code.push("mdest="+t[2]+";"),e.code.push("if (mdest < msrc) {"),e.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) MemW1(mdest, Mem1(msrc));"),e.code.push("} else {"),e.code.push("msrc += (mlen-1); mdest += (mlen-1);"),e.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) MemW1(mdest, Mem1(msrc));"),e.code.push("}")},376:function(e,t){var n="heap_malloc("+t[0]+")";e.code.push(t[1]+n+");")},377:function(e,t){e.code.push("heap_free("+t[0]+");")},384:function(e,t){e.code.push("accel_address_map["+t[1]+"] = accel_func_map["+t[0]+"];")},385:function(e,t){e.code.push("if ("+t[0]+" < 9) {"),e.code.push("  accel_params["+t[0]+"] = "+t[1]+";"),e.code.push("}")},336:function(e,t){var n="linear_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"),("+t[6]+"))";e.code.push(t[7]+n+");")},337:function(e,t){var n="binary_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"),("+t[6]+"))";e.code.push(t[7]+n+");")},338:function(e,t){var n="linked_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"))";e.code.push(t[6]+n+");")},112:function(e,t){switch(e.curiosys){case 2:if(quot_isconstant(t[0])){var n=Number(t[0])&255;e.code.push("Glk.glk_put_char("+n+");")}else e.code.push("Glk.glk_put_char(("+t[0]+")&0xff);");break;case 1:oputil_unload_offstate(e),e.code.push("tempcallargs[0]=(("+t[0]+")&0xff);"),oputil_push_callstub(e,"0,0"),e.code.push("enter_function(iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},113:function(e,t){switch(e.curiosys){case 2:var n=oputil_signify_operand(e,t[0]);if(quot_isconstant(t[0])){var r=Number(n).toString(10);e.code.push("Glk.glk_put_jstring("+QuoteEscapeString(r)+", true);")}else e.code.push("Glk.glk_put_jstring(("+n+").toString(10), true);");break;case 1:oputil_unload_offstate(e),e.code.push("stream_num("+e.cp+","+t[0]+", false, 0);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},114:function(e,t){oputil_unload_offstate(e),e.code.push("if (stream_string("+e.cp+","+t[0]+", 0, 0)) return;")},115:function(e,t){switch(e.curiosys){case 2:if(quot_isconstant(t[0])){var n=Number(t[0]);e.code.push("Glk.glk_put_char_uni("+n+");")}else e.code.push("Glk.glk_put_char_uni("+t[0]+");");break;case 1:oputil_unload_offstate(e),e.code.push("tempcallargs[0]=("+t[0]+");"),oputil_push_callstub(e,"0,0"),e.code.push("enter_function(iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:}},320:function(e,t){e.code.push(t[0]+"stringtable)")},321:function(e,t){e.code.push("set_string_table("+t[0]+");")},328:function(e,t){e.code.push(t[0]+"iosysmode)"),e.code.push(t[1]+"iosysrock)")},329:function(e,t){e.code.push("set_iosys("+t[0]+","+t[1]+");");if(quot_isconstant(t[0])){var n=Number(t[0]);e.curiosys=n}else oputil_unload_offstate(e),e.code.push("pc = "+e.cp+";"),e.code.push("return;"),e.path_ends=!0},400:function(e,t){var n=oputil_signify_operand(e,t[0]);if(quot_isconstant(t[0])){var r=Number(n);e.code.push(t[1]+encode_float(r)+");")}else e.code.push(t[1]+"encode_float("+n+"));")},401:function(e,t){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+oputil_decode_float(e,t[0])+";"),e.code.push("if (!("+t[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.floor(valf);"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.ceil(valf);"),e.code.push("}"),e.code.push(t[1]+"res>>>0);")},402:function(e,t){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+oputil_decode_float(e,t[0])+";"),e.code.push("if (!("+t[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res < -0x80000000) res = -0x80000000;"),e.code.push("}"),e.code.push(t[1]+"res>>>0);")},408:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.ceil("+n+")));")},409:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.floor("+n+")));")},416:function(e,t){var n=oputil_decode_float(e,t[0]),r=oputil_decode_float(e,t[1]);e.code.push(t[2]+"encode_float("+n+" + "+r+"));")},417:function(e,t){var n=oputil_decode_float(e,t[0]),r=oputil_decode_float(e,t[1]);e.code.push(t[2]+"encode_float("+n+" - "+r+"));")},418:function(e,t){var n=oputil_decode_float(e,t[0]),r=oputil_decode_float(e,t[1]);e.code.push(t[2]+"encode_float("+n+" * "+r+"));")},419:function(e,t){var n=oputil_decode_float(e,t[0]),r=oputil_decode_float(e,t[1]);e.code.push(t[2]+"encode_float("+n+" / "+r+"));")},420:function(e,t){var n=oputil_decode_float(e,t[0],!0),r=oputil_decode_float(e,t[1],!0);e.varsused.modv=!0,e.varsused.quov=!0,e.code.push("modv=("+n+" % "+r+");"),e.code.push("quov=encode_float(("+n+" - modv) / "+r+");"),e.code.push("if (quov == 0x0 || quov == 0x80000000) {"),e.code.push("  quov = (("+t[0]+" ^ "+t[1]+") & 0x80000000) >>>0;"),e.code.push("}"),e.code.push(t[2]+"encode_float(modv));"),e.code.push(t[3]+"quov);")},424:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.sqrt("+n+")));")},425:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.exp("+n+")));")},426:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.log("+n+")));")},427:function(e,t){e.varsused.valf=!0;var n=oputil_decode_float(e,t[0],!0),r=oputil_decode_float(e,t[1],!0);e.code.push("if ("+t[0]+" == 0x3f800000) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else if ("+t[0]+" == 0xbf800000 && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else {"),e.code.push("  valf=encode_float(Math.pow("+n+", "+r+"));"),e.code.push("}"),e.code.push(t[2]+"valf);")},432:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.sin("+n+")));")},433:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.cos("+n+")));")},434:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.tan("+n+")));")},435:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.asin("+n+")));")},436:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.acos("+n+")));")},437:function(e,t){var n=oputil_decode_float(e,t[0]);e.code.push(t[1]+"encode_float(Math.atan("+n+")));")},438:function(e,t){var n=oputil_decode_float(e,t[0]),r=oputil_decode_float(e,t[1]);e.code.push(t[2]+"encode_float(Math.atan2("+n+", "+r+")));")},448:function(e,t){var n,r,i,s;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+t[2]+" & 0x7f800000) == 0x7f800000 && ("+t[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+t[0]+" == "+t[1]+");"),e.code.push("} else {"),quot_isconstant(t[2])?(n=Number(t[2]),s=""+decode_float(n&2147483647)):(n="decode_float(("+t[2]+") & 0x7fffffff)",s=alloc_holdvar(e),e.code.push(s+"="+n+";")),r=oputil_decode_float(e,t[0]),i=oputil_decode_float(e,t[1]),e.code.push("  fdiff = "+i+" - "+r+";"),e.code.push("  fequal = (fdiff <= "+s+" && fdiff >= -("+s+"));"),e.code.push("}"),e.code.push("if (fequal) {"),oputil_perform_jump(e,t[3]),e.code.push("}")},449:function(e,t){var n,r,i,s;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+t[2]+" & 0x7f800000) == 0x7f800000 && ("+t[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+t[0]+" == "+t[1]+");"),e.code.push("} else {"),quot_isconstant(t[2])?(n=Number(t[2]),s=""+decode_float(n&2147483647)):(n="decode_float(("+t[2]+") & 0x7fffffff)",s=alloc_holdvar(e),e.code.push(s+"="+n+";")),r=oputil_decode_float(e,t[0]),i=oputil_decode_float(e,t[1]),e.code.push("  fdiff = "+i+" - "+r+";"),e.code.push("  fequal = (fdiff <= "+s+" && fdiff >= -("+s+"));"),e.code.push("}"),e.code.push("if (!fequal) {"),oputil_perform_jump(e,t[3]),e.code.push("}")},450:function(e,t){valf0=oputil_decode_float(e,t[0]),valf1=oputil_decode_float(e,t[1]),e.code.push("if ("+valf0+" < "+valf1+") {"),oputil_perform_jump(e,t[2]),e.code.push("}")},451:function(e,t){valf0=oputil_decode_float(e,t[0]),valf1=oputil_decode_float(e,t[1]),e.code.push("if ("+valf0+" <= "+valf1+") {"),oputil_perform_jump(e,t[2]),e.code.push("}")},452:function(e,t){valf0=oputil_decode_float(e,t[0]),valf1=oputil_decode_float(e,t[1]),e.code.push("if ("+valf0+" > "+valf1+") {"),oputil_perform_jump(e,t[2]),e.code.push("}")},453:function(e,t){valf0=oputil_decode_float(e,t[0]),valf1=oputil_decode_float(e,t[1]),e.code.push("if ("+valf0+" >= "+valf1+") {"),oputil_perform_jump(e,t[2]),e.code.push("}")},456:function(e,t){e.code.push("if (("+t[0]+" & 0x7f800000) == 0x7f800000 && ("+t[0]+" & 0x007fffff) != 0) {"),oputil_perform_jump(e,t[1]),e.code.push("}")},457:function(e,t){e.code.push("if ("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) {"),oputil_perform_jump(e,t[1]),e.code.push("}")},304:function(e,t){var n;quot_isconstant(t[0])?n=Glk.call_may_not_return(Number(t[0])):n=!0,e.code.push("tempglkargs.length = "+t[1]+";");if(quot_isconstant(t[1])){var r,i=Number(t[1]);for(r=0;r<i;r++)if(e.offstack.length){var s=pop_offstack_holdvar(e);e.code.push("tempglkargs["+r+"]="+s+";")}else e.code.push("tempglkargs["+r+"]=frame.valstack.pop();");oputil_unload_offstate(e)}else e.varsused.ix=!0,oputil_unload_offstate(e),e.code.push("for (ix=0; ix<"+t[1]+"; ix++) { tempglkargs[ix]=frame.valstack.pop(); }");e.varsused.glkret=!0,e.code.push("glkret = GiDispa.get_function("+t[0]+")(tempglkargs);"),n&&(e.code.push("if (glkret === Glk.DidNotReturn) {"),e.code.push("  resumefuncop = "+oputil_record_funcop(t[2])+";"),e.code.push("  resumevalue = 0;"),e.code.push("  pc = "+e.cp+";"),e.code.push("  done_executing = true;"),e.code.push("  return;"),e.code.push("}")),oputil_store(e,t[2],"glkret")}},ReturnedFromMain={dummy:"The top-level function has returned."},srand_table=undefined,srand_index1,srand_index2,accel_address_map={},accel_params=[0,0,0,0,0,0,0,0,0],accel_func_map={1:function(t,n){if(t<1)return 0;var r=n[0];if(r<36)return 0;if(r>=endmem)return 0;var i=Mem1(r);return i>=224?3:i>=192?2:i>=112&&i<=127&&r>=ramstart?1:0},2:function(t,n){var r=t>0?n[0]:0,i=t>1?n[1]:0;if(accel_func_map[1](t,n)!=1)return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var s=Mem4(r+16);if(!s)return 0;var o=Mem4(s);return s+=4,binary_search(i,2,s,10,o,0,0)},3:function(t,n){var r=t>0?n[0]:0,i=t>1?n[1]:0,s=accel_helper_get_prop(r,i);return s==0?0:Mem4(s+4)},4:function(t,n){var r=t>0?n[0]:0,i=t>1?n[1]:0,s=accel_helper_get_prop(r,i);return s==0?0:4*Mem2(s+2)},5:function(t,n){var r,i,s,o,u,a=t>0?n[0]:0,f=t>1?n[1]:0;r=accel_func_map[1](t,n);if(r==3)return f==accel_params[5]?1:0;if(r==2)return f==accel_params[4]?1:0;if(r!=1)return 0;if(f==accel_params[2])return accel_helper_obj_in_class(a)?1:a==accel_params[2]?1:a==accel_params[5]?1:a==accel_params[4]?1:a==accel_params[3]?1:0;if(f==accel_params[3])return accel_helper_obj_in_class(a)?0:a==accel_params[2]?0:a==accel_params[5]?0:a==accel_params[4]?0:a==accel_params[3]?0:1;if(f==accel_params[5]||f==accel_params[4])return 0;if(!accel_helper_obj_in_class(f))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;i=accel_helper_get_prop(a,2);if(i==0)return 0;s=Mem4(i+4);if(s==0)return 0;o=Mem2(i+2);for(u=0;u<o;u++)if(Mem4(s+4*u)==f)return 1;return 0},6:function(t,n){var r=t>1?n[1]:0,i;return i=accel_func_map[3](t,n),i==0?r>0&&r<accel_params[1]?Mem4(accel_params[8]+4*r):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):Mem4(i)},7:function(t,n){var r=t>0?n[0]:0,i=t>1?n[1]:0,s=accel_params[1],o=accel_func_map[1](t,n);return o==3?i==s+6?1:i==s+7?1:0:o==2?i==s+5?1:0:o!=1?0:i>=s&&i<s+8&&accel_helper_obj_in_class(r)?1:accel_func_map[3](t,n)?1:0}},accel_helper_temp_args=[0,0],tempsearchkey=[],game_image=null,game_signature=null,opt_rethrow_exceptions=null,memmap,stack,frame,vm_started=!1,vm_stopped=!1,tempcallargs,tempglkargs,done_executing,vmfunc_table,vmtextenv_table,decoding_tree,vmstring_table,random_func,ramstart,endgamefile,origendmem,stacksize,startfuncaddr,origstringtable,checksum,pc,stringtable,endmem,protectstart,protectend,iosysmode,iosysrock,undostack,resumefuncop,resumevalue,heapstart,usedlist,freelist,total_execution_time=0,total_function_calls=0,accel_function_calls=0,total_path_calls=0,paths_cached=0,paths_compiled=0,strings_cached=0,strings_compiled=0,debuginfo={map:{},functions:[],functionmap:{}};return{version:"1.3.0",prepare:quixe_prepare,init:quixe_init,resume:quixe_resume,get_signature:quixe_get_signature,get_statistics:quixe_get_statistics,get_debuginfo:quixe_get_debuginfo,ReadByte:ReadArgByte,WriteByte:WriteArgByte,ReadWord:ReadArgWord,WriteWord:WriteArgWord,ReadStructField:ReadStructField,WriteStructField:WriteStructField,SetResumeStore:SetResumeStore}}(),GiDispa=function(){function set_vm(e){VM=e}function FuncSpec(e,t,n){this.id=e,this.name=t,this.proto=n}function Prototype(e,t){this.args=e,this.retarg=t}function ArgString(){this.macro="Byte",this.refsize=1}function ArgUnicode(){this.macro="Word",this.refsize=4}function ArgChar(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned"}function ArgInt(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned"}function ArgClass(e){this.name=e,this.macro="Word",this.refsize=4}function ArgStruct(e){this.form=e}function ArgRef(e,t,n,r){this.arg=e,this.passin=t,this.passout=n,this.nonnull=r}function ArgArray(e,t,n,r,i){this.arg=e,this.retained=t,this.passin=n,this.passout=r,this.nonnull=i}function convert_arg(e,t,n){return e instanceof ArgInt?t?e.signed?n+" & 0xFFFFFFFF":n:"0":e instanceof ArgChar?t?e.signed?"cast_signed_char("+n+")":n+" & 0xFF":"0":e instanceof ArgClass?t?'class_obj_from_id("'+e.name+'", '+n+")":"null":"???"}function unconvert_arg(e,t){return e instanceof ArgInt?t+" >>> 0":e instanceof ArgChar?e.signed?"uncast_signed_char("+t+")":t+" & 0xFF":e instanceof ArgClass?'class_obj_to_id("'+e.name+'", '+t+")":"???"}function cast_signed_char(e){return e&=255,e&128&&(e-=256),e}function uncast_signed_char(e){return e&=255,e&128&&(e+=4294967040),e}function class_obj_to_id(e,t){return t?t.disprock:0}function class_obj_from_id(e,t){return t==0?null:class_map[e][t]}function build_function(func){var ix,jx,form,retarg,argpos,argjoin,subargs,arg,refarg,tmpvar,val,retval,ls,mayblock,out=[],locals={},arraycount=0;out.push("// no local vars"),out.push("// "+func.id+": "+func.name),form=func.proto,retarg=null,form.retarg&&(retarg=form.retarg.arg),mayblock=Glk.call_may_not_return(func.id),argpos=0,argjoin=[];for(ix=0;ix<form.args.length;ix++){arg=form.args[ix],tmpvar="glka"+ix,argjoin.push(tmpvar),locals[tmpvar]=!0;if(arg instanceof ArgInt||arg instanceof ArgChar||arg instanceof ArgClass)val=convert_arg(arg,!0,"callargs["+argpos+"]"),out.push(tmpvar+" = "+val+";"),argpos+=1;else if(arg instanceof ArgRef){refarg=arg.arg,out.push("if (callargs["+argpos+"] == 0) {"),arg.nonnull?out.push('  throw("glk '+func.name+': null argument");'):out.push("  "+tmpvar+" = null;"),out.push("} else {");if(refarg instanceof ArgInt||refarg instanceof ArgChar||refarg instanceof ArgClass)out.push("  "+tmpvar+" = new Glk.RefBox();"),val=convert_arg(refarg,arg.passin,"VM.ReadWord(callargs["+argpos+"])"),out.push("  "+tmpvar+".set_value("+val+");");else{if(!(refarg instanceof ArgStruct))throw"buildfunc: unsupported refarg type: "+func.name;subargs=refarg.form.args,out.push("  "+tmpvar+" = new Glk.RefStruct("+subargs.length+");");for(jx=0;jx<subargs.length;jx++)val=convert_arg(subargs[jx],arg.passin,"VM.ReadStructField(callargs["+argpos+"], "+jx+")"),out.push("  "+tmpvar+".push_field("+val+");")}out.push("}"),argpos+=1}else if(arg instanceof ArgArray)locals.glklen=!0,refarg=arg.arg,out.push("if (callargs["+argpos+"] == 0) {"),arg.nonnull?out.push('  throw("glk '+func.name+': null argument");'):out.push("  "+tmpvar+" = null;"),out.push("} else {"),out.push("  glklen = callargs["+(argpos+1)+"];"),out.push("  "+tmpvar+" = Array(glklen);"),arg.passin&&(locals.ix=!0,locals.jx=!0,out.push("  for (ix=0, jx=callargs["+argpos+"]; ix<glklen; ix++, jx+="+refarg.refsize+") {"),val=convert_arg(refarg,!0,"VM.Read"+refarg.macro+"(jx)"),out.push("    "+tmpvar+"[ix] = "+val+";"),out.push("  }")),arg.retained&&(arraycount==0&&out.push("  temp_arg_arrays.length = 0;"),arraycount+=1,out.push("  make_arg_array("+tmpvar+", callargs["+argpos+"], glklen, "+refarg.literal+");")),out.push("}"),argpos+=2;else{if(!(arg instanceof ArgString||arg instanceof ArgUnicode))throw"buildfunc: unsupported arg type: "+func.name;locals.ix=!0,locals.jx=!0;var confunc,checkbyte;arg instanceof ArgString?(checkbyte="0xE0",confunc="byte_array_to_string"):(checkbyte="0xE2",confunc="uni_array_to_string"),out.push(tmpvar+" = Array();"),out.push("jx = callargs["+argpos+"];"),out.push("if (VM.ReadByte(jx) != "+checkbyte+') throw("glk '+func.name+': string argument must be unencoded");'),out.push("for (jx+="+arg.refsize+"; true; jx+="+arg.refsize+") {"),out.push("  ix = VM.Read"+arg.macro+"(jx);"),out.push("  if (ix == 0) break;"),out.push("  "+tmpvar+".push(ix);"),out.push("}"),out.push(tmpvar+" = Glk."+confunc+"("+tmpvar+");"),argpos+=1}}out.push("if (callargs.length != "+argpos+') throw "glk '+func.name+': wrong number of arguments";'),retarg||mayblock?(locals.glkret=!0,retval="glkret = "):retval="",out.push(retval+"Glk.glk_"+func.name+"("+argjoin.join(", ")+");"),mayblock&&(out.push("if (glkret === Glk.DidNotReturn) {"),out.push("  set_blocked_selector("+func.id+", callargs);"),out.push("  return glkret;"),out.push("}")),argpos=0;for(ix=0;ix<form.args.length;ix++){arg=form.args[ix],tmpvar="glka"+ix;if(arg instanceof ArgInt||arg instanceof ArgChar||arg instanceof ArgClass)argpos+=1;else if(arg instanceof ArgRef){refarg=arg.arg;if(arg.passout){out.push("if ("+tmpvar+") {");if(refarg instanceof ArgInt||refarg instanceof ArgChar||refarg instanceof ArgClass)val=unconvert_arg(refarg,tmpvar+".get_value()"),out.push("  VM.WriteWord(callargs["+argpos+"], "+val+");");else{if(!(refarg instanceof ArgStruct))throw"buildfunc: unsupported refarg type: "+func.name;subargs=refarg.form.args;for(jx=0;jx<subargs.length;jx++)val=unconvert_arg(subargs[jx],tmpvar+".get_field("+jx+")"),out.push("  VM.WriteStructField(callargs["+argpos+"], "+jx+", "+val+");")}out.push("}")}argpos+=1}else if(arg instanceof ArgArray)refarg=arg.arg,arg.passout&&!arg.retained&&(out.push("if ("+tmpvar+") {"),locals.ix=!0,locals.jx=!0,out.push("  for (ix=0, jx=callargs["+argpos+"]; ix<glklen; ix++, jx+="+refarg.refsize+") {"),val=unconvert_arg(refarg,tmpvar+"[ix]"),out.push("    VM.Write"+refarg.macro+"(jx, "+val+")"),out.push("  }"),out.push("}")),argpos+=2;else{if(!(arg instanceof ArgString||arg instanceof ArgUnicode))throw"buildfunc: unsupported arg type: "+func.name;argpos+=1}}arraycount!=0&&out.push("temp_arg_arrays.length = 0;"),retarg?(val=unconvert_arg(retarg,"glkret"),out.push("return "+val+";")):out.push("return 0;"),ls=[];for(val in locals)ls.push(val);return ls.length&&(out[0]="var "+ls.join(", ")+";"),val=out.join("\n"),eval("function _func(callargs) {\n"+val+"\n}"),_func}function get_function(e){var t,n=function_map[e];if(n===undefined){t=proto_map[e];if(t===undefined)throw"dispatch: unknown Glk function: "+e;n=build_function(t),function_map[e]=n}return n}function set_blocked_selector(e,t){blocked_selector=e,blocked_callargs=t.slice(0)}function prepare_resume(e){blocked_selector==192?blocked_callargs[0]!=0&&(VM.WriteStructField(blocked_callargs[0],0,e.get_field(0)>>>0),VM.WriteStructField(blocked_callargs[0],1,class_obj_to_id("window",e.get_field(1))),VM.WriteStructField(blocked_callargs[0],2,e.get_field(2)>>>0),VM.WriteStructField(blocked_callargs[0],3,e.get_field(3)>>>0)):blocked_selector==98&&VM.SetResumeStore(class_obj_to_id("fileref",e)),blocked_selector=null,blocked_callargs=null}function make_arg_array(e,t,n,r){var i;if(!e)return;i={arr:e,addr:t,len:n,arg:r},temp_arg_arrays.push(i)}function retain_array(e){var t,n;if(!e)return;n=undefined;for(t=0;t<temp_arg_arrays.length;t++)if(temp_arg_arrays[t].arr===e){n=temp_arg_arrays[t];break}if(n===undefined)throw"retain_array: array is not an argument";for(t=0;retained_arrays[t]!==undefined;t++);retained_arrays[t]=n}function unretain_array(e){var t,n,r;if(!e)return;r=undefined;for(t=0;t<retained_arrays.length;t++){if(retained_arrays[t]===undefined)continue;if(retained_arrays[t].arr===e){r=retained_arrays[t],delete retained_arrays[t];break}}if(r===undefined)throw"unretain_array: array was never retained";if(r.arg instanceof ArgInt)for(t=0,n=r.addr;t<r.len;t++,n+=4)VM.WriteWord(n,r.arr[t]>>>0);else{if(!(r.arg instanceof ArgChar))throw"unretain_array: unsupported refarg type";if(!r.arg.signed)for(t=0,n=r.addr;t<r.len;t++,n++)VM.WriteByte(n,r.arr[t]&255);else for(t=0,n=r.addr;t<r.len;t++,n++)VM.WriteByte(n,uncast_signed_char(r.arr[t]))}}function class_register(e,t){if(t.disprock)throw"class_register: object is already registered";t.disprock=last_used_id,last_used_id++,class_map[e][t.disprock]=t}function class_unregister(e,t){if(!t.disprock||class_map[e][t.disprock]===undefined)throw"class_unregister: object is not registered";delete class_map[e][t.disprock],t.disprock=undefined}function init_module(){var e,t;last_used_id=1+Math.round(Math.random()*1e3);for(e in class_defs)t=class_defs[e],class_map[t]={}}var VM=null,class_defs={0:"window",1:"stream",2:"fileref",3:"schannel"},arg_int_unsigned=new ArgInt(!1),arg_int_signed=new ArgInt(!0),arg_char_unsigned=new ArgChar(!1),arg_char_native=new ArgChar(null),arg_char_signed=new ArgChar(!0),arg_class_window=new ArgClass("window"),arg_class_stream=new ArgClass("stream"),arg_class_fileref=new ArgClass("fileref"),arg_class_schannel=new ArgClass("schannel"),proto_map={1:new FuncSpec(1,"exit",new Prototype([],null)),3:new FuncSpec(3,"tick",new Prototype([],null)),4:new FuncSpec(4,"gestalt",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),5:new FuncSpec(5,"gestalt_ext",new Prototype([arg_int_unsigned,arg_int_unsigned,new ArgArray(arg_int_unsigned,!1,!0,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),32:new FuncSpec(32,"window_iterate",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_window,!1,!0,!0))),33:new FuncSpec(33,"window_get_rock",new Prototype([arg_class_window],new ArgRef(arg_int_unsigned,!1,!0,!0))),34:new FuncSpec(34,"window_get_root",new Prototype([],new ArgRef(arg_class_window,!1,!0,!0))),35:new FuncSpec(35,"window_open",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_window,!1,!0,!0))),36:new FuncSpec(36,"window_close",new Prototype([arg_class_window,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),37:new FuncSpec(37,"window_get_size",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1)],null)),38:new FuncSpec(38,"window_set_arrangement",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,arg_class_window],null)),39:new FuncSpec(39,"window_get_arrangement",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_class_window,!1,!0,!1)],null)),40:new FuncSpec(40,"window_get_type",new Prototype([arg_class_window],new ArgRef(arg_int_unsigned,!1,!0,!0))),41:new FuncSpec(41,"window_get_parent",new Prototype([arg_class_window],new ArgRef(arg_class_window,!1,!0,!0))),42:new FuncSpec(42,"window_clear",new Prototype([arg_class_window],null)),43:new FuncSpec(43,"window_move_cursor",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),44:new FuncSpec(44,"window_get_stream",new Prototype([arg_class_window],new ArgRef(arg_class_stream,!1,!0,!0))),45:new FuncSpec(45,"window_set_echo_stream",new Prototype([arg_class_window,arg_class_stream],null)),46:new FuncSpec(46,"window_get_echo_stream",new Prototype([arg_class_window],new ArgRef(arg_class_stream,!1,!0,!0))),47:new FuncSpec(47,"set_window",new Prototype([arg_class_window],null)),48:new FuncSpec(48,"window_get_sibling",new Prototype([arg_class_window],new ArgRef(arg_class_window,!1,!0,!0))),64:new FuncSpec(64,"stream_iterate",new Prototype([arg_class_stream,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_stream,!1,!0,!0))),65:new FuncSpec(65,"stream_get_rock",new Prototype([arg_class_stream],new ArgRef(arg_int_unsigned,!1,!0,!0))),66:new FuncSpec(66,"stream_open_file",new Prototype([arg_class_fileref,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),67:new FuncSpec(67,"stream_open_memory",new Prototype([new ArgArray(arg_char_native,!0,!0,!0,!1),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),68:new FuncSpec(68,"stream_close",new Prototype([arg_class_stream,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),69:new FuncSpec(69,"stream_set_position",new Prototype([arg_class_stream,arg_int_signed,arg_int_unsigned],null)),70:new FuncSpec(70,"stream_get_position",new Prototype([arg_class_stream],new ArgRef(arg_int_unsigned,!1,!0,!0))),71:new FuncSpec(71,"stream_set_current",new Prototype([arg_class_stream],null)),72:new FuncSpec(72,"stream_get_current",new Prototype([],new ArgRef(arg_class_stream,!1,!0,!0))),73:new FuncSpec(73,"stream_open_resource",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),96:new FuncSpec(96,"fileref_create_temp",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),97:new FuncSpec(97,"fileref_create_by_name",new Prototype([arg_int_unsigned,new ArgString,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),98:new FuncSpec(98,"fileref_create_by_prompt",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),99:new FuncSpec(99,"fileref_destroy",new Prototype([arg_class_fileref],null)),100:new FuncSpec(100,"fileref_iterate",new Prototype([arg_class_fileref,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_fileref,!1,!0,!0))),101:new FuncSpec(101,"fileref_get_rock",new Prototype([arg_class_fileref],new ArgRef(arg_int_unsigned,!1,!0,!0))),102:new FuncSpec(102,"fileref_delete_file",new Prototype([arg_class_fileref],null)),103:new FuncSpec(103,"fileref_does_file_exist",new Prototype([arg_class_fileref],new ArgRef(arg_int_unsigned,!1,!0,!0))),104:new FuncSpec(104,"fileref_create_from_fileref",new Prototype([arg_int_unsigned,arg_class_fileref,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),128:new FuncSpec(128,"put_char",new Prototype([arg_char_unsigned],null)),129:new FuncSpec(129,"put_char_stream",new Prototype([arg_class_stream,arg_char_unsigned],null)),130:new FuncSpec(130,"put_string",new Prototype([new ArgString],null)),131:new FuncSpec(131,"put_string_stream",new Prototype([arg_class_stream,new ArgString],null)),132:new FuncSpec(132,"put_buffer",new Prototype([new ArgArray(arg_char_native,!1,!0,!1,!0)],null)),133:new FuncSpec(133,"put_buffer_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!0,!1,!0)],null)),134:new FuncSpec(134,"set_style",new Prototype([arg_int_unsigned],null)),135:new FuncSpec(135,"set_style_stream",new Prototype([arg_class_stream,arg_int_unsigned],null)),144:new FuncSpec(144,"get_char_stream",new Prototype([arg_class_stream],new ArgRef(arg_int_signed,!1,!0,!0))),145:new FuncSpec(145,"get_line_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),146:new FuncSpec(146,"get_buffer_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),160:new FuncSpec(160,"char_to_lower",new Prototype([arg_char_unsigned],new ArgRef(arg_char_unsigned,!1,!0,!0))),161:new FuncSpec(161,"char_to_upper",new Prototype([arg_char_unsigned],new ArgRef(arg_char_unsigned,!1,!0,!0))),176:new FuncSpec(176,"stylehint_set",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned,arg_int_signed],null)),177:new FuncSpec(177,"stylehint_clear",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],null)),178:new FuncSpec(178,"style_distinguish",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),179:new FuncSpec(179,"style_measure",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),192:new FuncSpec(192,"select",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!0)],null)),193:new FuncSpec(193,"select_poll",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!0)],null)),208:new FuncSpec(208,"request_line_event",new Prototype([arg_class_window,new ArgArray(arg_char_native,!0,!0,!0,!0),arg_int_unsigned],null)),209:new FuncSpec(209,"cancel_line_event",new Prototype([arg_class_window,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),210:new FuncSpec(210,"request_char_event",new Prototype([arg_class_window],null)),211:new FuncSpec(211,"cancel_char_event",new Prototype([arg_class_window],null)),212:new FuncSpec(212,"request_mouse_event",new Prototype([arg_class_window],null)),213:new FuncSpec(213,"cancel_mouse_event",new Prototype([arg_class_window],null)),214:new FuncSpec(214,"request_timer_events",new Prototype([arg_int_unsigned],null)),224:new FuncSpec(224,"image_get_info",new Prototype([arg_int_unsigned,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),225:new FuncSpec(225,"image_draw",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed],new ArgRef(arg_int_unsigned,!1,!0,!0))),226:new FuncSpec(226,"image_draw_scaled",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),232:new FuncSpec(232,"window_flow_break",new Prototype([arg_class_window],null)),233:new FuncSpec(233,"window_erase_rect",new Prototype([arg_class_window,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],null)),234:new FuncSpec(234,"window_fill_rect",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],null)),235:new FuncSpec(235,"window_set_background_color",new Prototype([arg_class_window,arg_int_unsigned],null)),240:new FuncSpec(240,"schannel_iterate",new Prototype([arg_class_schannel,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_schannel,!1,!0,!0))),241:new FuncSpec(241,"schannel_get_rock",new Prototype([arg_class_schannel],new ArgRef(arg_int_unsigned,!1,!0,!0))),242:new FuncSpec(242,"schannel_create",new Prototype([arg_int_unsigned],new ArgRef(arg_class_schannel,!1,!0,!0))),243:new FuncSpec(243,"schannel_destroy",new Prototype([arg_class_schannel],null)),244:new FuncSpec(244,"schannel_create_ext",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_schannel,!1,!0,!0))),247:new FuncSpec(247,"schannel_play_multi",new Prototype([new ArgArray(arg_class_schannel,!1,!0,!1,!0),new ArgArray(arg_int_unsigned,!1,!0,!1,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),248:new FuncSpec(248,"schannel_play",new Prototype([arg_class_schannel,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),249:new FuncSpec(249,"schannel_play_ext",new Prototype([arg_class_schannel,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),250:new FuncSpec(250,"schannel_stop",new Prototype([arg_class_schannel],null)),251:new FuncSpec(251,"schannel_set_volume",new Prototype([arg_class_schannel,arg_int_unsigned],null)),252:new FuncSpec(252,"sound_load_hint",new Prototype([arg_int_unsigned,arg_int_unsigned],null)),253:new FuncSpec(253,"schannel_set_volume_ext",new Prototype([arg_class_schannel,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],null)),254:new FuncSpec(254,"schannel_pause",new Prototype([arg_class_schannel],null)),255:new FuncSpec(255,"schannel_unpause",new Prototype([arg_class_schannel],null)),256:new FuncSpec(256,"set_hyperlink",new Prototype([arg_int_unsigned],null)),257:new FuncSpec(257,"set_hyperlink_stream",new Prototype([arg_class_stream,arg_int_unsigned],null)),258:new FuncSpec(258,"request_hyperlink_event",new Prototype([arg_class_window],null)),259:new FuncSpec(259,"cancel_hyperlink_event",new Prototype([arg_class_window],null)),288:new FuncSpec(288,"buffer_to_lower_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),289:new FuncSpec(289,"buffer_to_upper_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),290:new FuncSpec(290,"buffer_to_title_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),291:new FuncSpec(291,"buffer_canon_decompose_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),292:new FuncSpec(292,"buffer_canon_normalize_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),296:new FuncSpec(296,"put_char_uni",new Prototype([arg_int_unsigned],null)),297:new FuncSpec(297,"put_string_uni",new Prototype([new ArgUnicode],null)),298:new FuncSpec(298,"put_buffer_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!1,!0)],null)),299:new FuncSpec(299,"put_char_stream_uni",new Prototype([arg_class_stream,arg_int_unsigned],null)),300:new FuncSpec(300,"put_string_stream_uni",new Prototype([arg_class_stream,new ArgUnicode],null)),301:new FuncSpec(301,"put_buffer_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!0,!1,!0)],null)),304:new FuncSpec(304,"get_char_stream_uni",new Prototype([arg_class_stream],new ArgRef(arg_int_signed,!1,!0,!0))),305:new FuncSpec(305,"get_buffer_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),306:new FuncSpec(306,"get_line_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),312:new FuncSpec(312,"stream_open_file_uni",new Prototype([arg_class_fileref,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),313:new FuncSpec(313,"stream_open_memory_uni",new Prototype([new ArgArray(arg_int_unsigned,!0,!0,!0,!1),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),314:new FuncSpec(314,"stream_open_resource_uni",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),320:new FuncSpec(320,"request_char_event_uni",new Prototype([arg_class_window],null)),321:new FuncSpec(321,"request_line_event_uni",new Prototype([arg_class_window,new ArgArray(arg_int_unsigned,!0,!0,!0,!0),arg_int_unsigned],null)),336:new FuncSpec(336,"set_echo_line_event",new Prototype([arg_class_window,arg_int_unsigned],null)),337:new FuncSpec(337,"set_terminators_line_event",new Prototype([arg_class_window,new ArgArray(arg_int_unsigned,!1,!0,!1,!1)],null)),352:new FuncSpec(352,"current_time",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),353:new FuncSpec(353,"current_simple_time",new Prototype([arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0))),360:new FuncSpec(360,"time_to_date_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),361:new FuncSpec(361,"time_to_date_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),362:new FuncSpec(362,"simple_time_to_date_utc",new Prototype([arg_int_signed,arg_int_unsigned,new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),363:new FuncSpec(363,"simple_time_to_date_local",new Prototype([arg_int_signed,arg_int_unsigned,new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),364:new FuncSpec(364,"date_to_time_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),365:new FuncSpec(365,"date_to_time_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),366:new FuncSpec(366,"date_to_simple_time_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0))),367:new FuncSpec(367,"date_to_simple_time_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0)))},function_map={},blocked_selector=null,blocked_callargs=null,temp_arg_arrays=[],retained_arrays=[],class_map={},last_used_id;return init_module(),{set_vm:set_vm,get_function:get_function,prepare_resume:prepare_resume,class_register:class_register,class_unregister:class_unregister,class_obj_to_id:class_obj_to_id,class_obj_from_id:class_obj_from_id,retain_array:retain_array,unretain_array:unretain_array}}(),GiLoad=function(){function i(n,r,i){e.vm=window.Quixe,e.io=window.Glk,n||(n=window.game_options),n&&Object.extend(e,n),t=null;if(e.use_query_story){var u=s();t=u.story}if(!t&&r){GlkOte.log("### trying pre-loaded load ("+i+")...");switch(i){case"base64":r=decode_base64(r);break;case"raw":r=decode_text(r);break;case"array":break;default:e.io.fatal_error("Could not decode story file data: "+i);return}c(r);return}t||(t=e.default_story);if(!t){e.io.fatal_error("No story file specified!");return}GlkOte.log("### gameurl: "+t),r=null,i=null;var a=Ajax.getTransport(),l=a.overrideMimeType!==undefined&&!Prototype.Browser.Opera,p=a.withCredentials!==undefined;a=null;var d=/^(file:|(\w+:)?\/\/[^\/?#]+)/,v=d.exec(location)[0],m=d.exec(t),g=m?!1:!0,y=m?m[0]:v,w=v==y;navigator.userAgent.match(/chrome/i)&&y=="file:"&&(w=!1);var E=t.toLowerCase().endsWith(".js");GlkOte.log("### is_relative="+g+", same_origin="+w+", binary_supported="+l+", crossorigin_supported="+p);if(E&&w){GlkOte.log("### trying old-fashioned load..."),window.processBase64Zcode=function(e){c(decode_base64(e))},new Ajax.Request(t,{method:"get",evalJS:"force",onFailure:function(n){e.io.fatal_error("The story could not be loaded. ("+t+"): Error "+n.status+": "+n.statusText)}});return}if(E){GlkOte.log("### trying script load..."),window.processBase64Zcode=function(e){c(decode_base64(e))};var S=$$("head");if(!S||S.length==0){e.io.fatal_error("This page has no <head> element!");return}var x=new Element("script",{src:t,type:"text/javascript"});S[0].insert(x);return}if(l&&w){GlkOte.log("### trying binary load..."),new Ajax.Request(t,{method:"get",onCreate:function(e){e.transport.overrideMimeType("text/plain; charset=x-user-defined")},onSuccess:function(e){c(f(e.responseText))},onFailure:function(n){e.io.fatal_error("The story could not be loaded. ("+t+"): Error "+n.status+": "+n.statusText)}});return}if(y=="file:"){e.io.fatal_error("The story could not be loaded. ("+t+"): A local file cannot be sent to the proxy.");return}var T=t;g&&(T=o(t),GlkOte.log("### absolutize "+t+" to "+T));if(p){GlkOte.log("### trying proxy load... ("+e.proxy_url+")"),new Ajax.Request(e.proxy_url,{method:"get",parameters:{encode:"base64",url:T},onFailure:function(n){e.io.fatal_error("The story could not be loaded. ("+t+"): Error "+n.status+": "+n.statusText)},onSuccess:function(e){c(decode_base64(e.responseText))}});return}var N=e.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+T;GlkOte.log("### trying proxy-script load... ("+N+")"),window.processBase64Zcode=function(e){c(decode_base64(e))};var S=$$("head");if(!S||S.length==0){e.io.fatal_error("This page has no <head> element!");return}var x=new Element("script",{src:N,type:"text/javascript"});S[0].insert(x);return}function s(){var e={},t=location.search.substring(1,location.search.length);if(t.length){var n=t.split("&");t=t.replace(/\+/g," ");for(var r=0;r<n.length;r++){var i=n[r].split("="),s=decodeURIComponent(i[0]),o=i.length==2?decodeURIComponent(i[1]):s;e[s]=o}}return e}function o(e){var t=new Element("div");return t.innerHTML="<a></a>",t.firstChild.href=e,t.innerHTML=t.innerHTML,t.firstChild.href}function u(e){return r[e]}function a(e){var t=e.length,i,s=[],o=null,u=12;while(u<t){var a=String.fromCharCode(e[u+0],e[u+1],e[u+2],e[u+3]);u+=4;var f=e[u+0]<<24|e[u+1]<<16|e[u+2]<<8|e[u+3];u+=4;if(a=="RIdx"){var l=u,c=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4;for(i=0;i<c;i++){var h=String.fromCharCode(e[l+0],e[l+1],e[l+2],e[l+3]);l+=4;var p=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4;var v=e[l+0]<<24|e[l+1]<<16|e[l+2]<<8|e[l+3];l+=4,s.push({usage:h,num:p,pos:v})}}if(a=="IFmd"){var m=e.slice(u,u+f),g=String.fromCharCode.apply(this,m);g=g.replace(/<title>/gi,"<xtitle>"),g=g.replace(/<\/title>/gi,"</xtitle>");var y=(new Element("metadata")).update(g);if(y.down("bibliographic")){var b=y.down("bibliographic").childElements(),w;for(i=0;i<b.length;i++)w=b[i],w.tagName.toLowerCase()=="xtitle"?n.title=w.textContent:n[w.tagName.toLowerCase()]=w.textContent}}u+=f,u&1&&u++}for(i=0;i<s.length;i++){var w=s[i];u=w.pos;var a=String.fromCharCode(e[u+0],e[u+1],e[u+2],e[u+3]);u+=4;var f=e[u+0]<<24|e[u+1]<<16|e[u+2]<<8|e[u+3];u+=4,w.usage=="Exec"&&w.num==0&&a=="GLUL"&&(o=e.slice(u,u+f)),w.usage=="Data"&&(a=="TEXT"||a=="BINA")&&(r[w.num]={data:e.slice(u,u+f),type:a}),w.usage=="Data"&&a=="FORM"&&(r[w.num]={data:e.slice(u-8,u+f),type:"BINA"})}return o}function f(e){var t=Array(e.length),n;for(n=0;n<e.length;n++)t[n]=e.charCodeAt(n)&255;return t}function c(r){if(r.length==0){e.io.fatal_error("No game file was loaded. (Zero-length response.)");return}if(r[0]==70&&r[1]==79&&r[2]==82&&r[3]==77){try{r=a(r)}catch(i){e.io.fatal_error("Blorb file could not be parsed: "+i);return}if(!r){e.io.fatal_error("Blorb file contains no Glulx game!");return}}if(e.set_page_title){var s=null;n&&(s=n.title),!s&&t&&(s=t.slice(t.lastIndexOf("/")+1)),s||(s="Game"),document.title=s+" - Quixe"}e.vm.prepare(r,e),e.io.init(e)}var e={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,proxy_url:"http://zcode.appspot.com/proxy/"},t=null,n={},r={};if(window.atob)decode_base64=function(e){var t=atob(e),n=Array(t.length),r;for(r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n};else{var l=function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=[],n;for(n=0;n<e.length;n++)t[e.charAt(n)]=n;return t}();decode_base64=function(e){var t=[],n,r,i,s,o,u,a,f=0,c=e.length;while(f<c)s=l[e.charAt(f++)],o=l[e.charAt(f++)],u=l[e.charAt(f++)],a=l[e.charAt(f++)],n=(s<<2)+(o>>4),r=((o&15)<<4)+(u>>2),i=((u&3)<<6)+a,t.push(n,r,i);return a==64&&t.pop(),u==64&&t.pop(),t}}return{load_run:i,find_data_chunk:u}}()